name: ðŸ”„ Update Stock Dashboard

on:
  # 1ì‹œê°„ë§ˆë‹¤ ìžë™ ì‹¤í–‰ (ë¯¸êµ­ ì‹œìž¥ ì‹œê°„ ê¸°ì¤€)
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œê°„ ì •ê°

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # í¬íŠ¸í´ë¦¬ì˜¤ ë³€ê²½ ì‹œ ì‹¤í–‰
  push:
    branches: [main]
    paths:
      - 'data/portfolio.json'
      - 'scripts/*.py'

permissions:
  contents: write
  pages: write

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        fetch-depth: 0

    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ðŸ“š Install dependencies
      run: |
        pip install yfinance pandas numpy

    - name: ðŸ“ˆ Fetch stock prices
      run: |
        python scripts/fetch_prices.py

    - name: ðŸ¤– Update AI portfolio
      run: |
        python scripts/ai_portfolio.py

    - name: ðŸ” Run value screener
      run: |
        python scripts/value_screener.py

    - name: ðŸ“‚ Verify output
      run: |
        echo "=== data/portfolio.json ==="
        cat data/portfolio.json | head -50
        echo ""
        echo "=== docs/data.json ==="
        cat docs/data.json | head -50
        echo ""
        echo "=== docs/screener.json (top stocks) ==="
        cat docs/screener.json | head -100

    - name: ðŸ“¤ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"

        git add data/portfolio.json data/history.json data/screener.json docs/data.json docs/screener.json docs/ai_data.json 2>/dev/null || true

        # ë³€ê²½ì‚¬í•­ì´ ìžˆì„ ë•Œë§Œ ì»¤ë°‹
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ”„ Auto update: $(date '+%Y-%m-%d %H:%M') UTC"
          git push
          echo "âœ… Dashboard updated successfully!"
        fi

    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸ“ˆ Stock Portfolio Update" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Updated at:** $(date '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Dashboard URL:** https://moonkaicuzui.github.io/stock-portfolio-genius/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Value Screener:** https://moonkaicuzui.github.io/stock-portfolio-genius/screener.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**AI Battle:** https://moonkaicuzui.github.io/stock-portfolio-genius/battle.html" >> $GITHUB_STEP_SUMMARY
