<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>ì£¼ì‹ í¬íŠ¸í´ë¦¬ì˜¤ ì§€ë‹ˆì–´ìŠ¤ - ê³ ê¸‰ íˆ¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 40px;
            width: 350px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .login-box h1 {
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .login-box p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
        }

        .login-input:focus {
            outline: none;
            border-color: #4ade80;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 222, 128, 0.3);
        }

        .login-error {
            color: #f87171;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.5rem;
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #ffffff33;
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .last-updated {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #f87171;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-card.highlight {
            border-color: #4ade80;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        .summary-card.warning {
            border-color: #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }

        .summary-card.danger {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        .summary-card .label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .summary-card .change {
            font-size: 0.9rem;
            margin-top: 6px;
        }

        .summary-card .tooltip {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        .neutral { color: #fbbf24; }

        /* Section Title */
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: normal;
        }

        /* Book Reference Badge */
        .book-ref {
            display: inline-block;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            margin-left: 8px;
            font-weight: normal;
        }

        /* Holdings Table */
        .holdings-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .holdings-table th,
        .holdings-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .holdings-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            text-transform: uppercase;
            position: sticky;
            top: 0;
        }

        .holdings-table tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        .holdings-table tr:hover {
            background: rgba(74, 222, 128, 0.1);
            transform: scale(1.01);
        }

        .symbol-cell {
            font-weight: bold;
            font-size: 1rem;
        }

        .symbol-name {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            font-weight: normal;
        }

        /* Score Badges */
        .score-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .score-badge.excellent { background: #22c55e; color: #000; }
        .score-badge.good { background: #84cc16; color: #000; }
        .score-badge.fair { background: #eab308; color: #000; }
        .score-badge.poor { background: #f97316; color: #000; }
        .score-badge.bad { background: #ef4444; color: #fff; }

        /* Lynch Category */
        .lynch-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .lynch-fast { background: #8b5cf6; color: #fff; }
        .lynch-stalwart { background: #3b82f6; color: #fff; }
        .lynch-slow { background: #6b7280; color: #fff; }
        .lynch-cyclical { background: #f59e0b; color: #000; }
        .lynch-turnaround { background: #ef4444; color: #fff; }
        .lynch-asset { background: #10b981; color: #fff; }

        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        /* Grid Layouts */
        .two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .three-col-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .four-col-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .three-col-grid { grid-template-columns: 1fr 1fr; }
            .four-col-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .two-col-grid, .three-col-grid, .four-col-grid {
                grid-template-columns: 1fr;
            }
            .holdings-table {
                display: block;
                overflow-x: auto;
            }
            .summary-card .value {
                font-size: 1.3rem;
            }
        }

        .allocation-chart {
            height: 250px;
        }

        /* Analysis Panel */
        .analysis-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .analysis-value {
            font-weight: bold;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Risk Meter */
        .risk-meter {
            display: flex;
            gap: 3px;
            margin-top: 8px;
        }

        .risk-bar {
            flex: 1;
            height: 20px;
            border-radius: 3px;
            opacity: 0.3;
        }

        .risk-bar.active {
            opacity: 1;
        }

        .risk-bar:nth-child(1) { background: #22c55e; }
        .risk-bar:nth-child(2) { background: #84cc16; }
        .risk-bar:nth-child(3) { background: #eab308; }
        .risk-bar:nth-child(4) { background: #f97316; }
        .risk-bar:nth-child(5) { background: #ef4444; }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.85rem;
        }

        footer a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Insight Cards */
        .insight-card {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .insight-card.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1));
            border-color: rgba(245, 158, 11, 0.3);
        }

        .insight-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-content {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Collapsible Section */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header::after {
            content: 'â–¼';
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .collapsible-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .modal-symbol {
            color: #4ade80;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .metric-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
            line-height: 1.4;
        }

        .formula-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #4ade80;
            margin-top: 10px;
        }

        .analysis-grade {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .grade-a { background: #22c55e; color: #000; }
        .grade-b { background: #84cc16; color: #000; }
        .grade-c { background: #eab308; color: #000; }
        .grade-d { background: #f97316; color: #000; }
        .grade-f { background: #ef4444; color: #fff; }

        .recommendation-box {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(59, 130, 246, 0.15));
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .recommendation-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #4ade80;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .recommendation-list li:last-child {
            border-bottom: none;
        }

        .recommendation-list li::before {
            content: 'ğŸ’¡';
        }

        /* Taleb Risk Indicator */
        .taleb-indicator {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-top: 8px;
        }

        .taleb-block {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .taleb-block.fragile { background: #ef4444; }
        .taleb-block.robust { background: #eab308; }
        .taleb-block.antifragile { background: #22c55e; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ì§€ë‹ˆì–´ìŠ¤</h1>
            <p>ê³ ê¸‰ íˆ¬ì ëŒ€ì‹œë³´ë“œì— ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
            <input type="text" id="loginId" class="login-input" placeholder="ì•„ì´ë””" autocomplete="username">
            <input type="password" id="loginPw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
            <button class="login-btn" onclick="attemptLogin()">ë¡œê·¸ì¸</button>
            <div id="loginError" class="login-error">ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="loading" style="display: none;">ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘...</div>

    <!-- Stock Detail Modal -->
    <div id="stockModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-symbol" id="modalSymbol">AAPL</span>
                    <span id="modalName">Apple Inc.</span>
                </div>
                <button class="modal-close" onclick="closeStockModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸ” ì¸ì¦ ì‹œìŠ¤í…œ
        // ============================================
        const AUTH_KEY = 'spg_auth_token';
        const VALID_HASH = '5f4dcc3b5aa765d61d8327deb882cf99'; // Simple hash for demo

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function attemptLogin() {
            const id = document.getElementById('loginId').value;
            const pw = document.getElementById('loginPw').value;

            // ì¸ì¦ í™•ì¸
            if (id === 'kaicuzui' && pw === 'ksmoon1!') {
                const token = simpleHash(id + pw + Date.now());
                sessionStorage.setItem(AUTH_KEY, token);
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginPw').value = '';
            }
        }

        function checkAuth() {
            const token = sessionStorage.getItem(AUTH_KEY);
            if (token) {
                showDashboard();
            }
        }

        function logout() {
            sessionStorage.removeItem(AUTH_KEY);
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadDashboard();
        }

        // Enter key login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                attemptLogin();
            }
        });

        // Check auth on page load
        window.onload = checkAuth;

        // ============================================
        // ğŸ“š íˆ¬ì ì„œì  ì•Œê³ ë¦¬ì¦˜ (16ê¶Œ)
        // ============================================

        /**
         * 1. Benjamin Graham - í˜„ëª…í•œ íˆ¬ìì
         * ê·¸ë ˆì´ì—„ ë„˜ë²„ = sqrt(22.5 Ã— EPS Ã— BVPS)
         * ì•ˆì „ë§ˆì§„ = (ë‚´ì¬ê°€ì¹˜ - ì‹œì¥ê°€ê²©) / ë‚´ì¬ê°€ì¹˜
         */
        function calculateGrahamNumber(eps, bookValuePerShare) {
            if (!eps || !bookValuePerShare || eps <= 0 || bookValuePerShare <= 0) return null;
            return Math.sqrt(22.5 * eps * bookValuePerShare);
        }

        function calculateMarginOfSafety(intrinsicValue, currentPrice) {
            if (!intrinsicValue || !currentPrice) return null;
            return ((intrinsicValue - currentPrice) / intrinsicValue) * 100;
        }

        /**
         * 2. Graham & Dodd - ì¦ê¶Œë¶„ì„
         * ìˆœìš´ì „ìë³¸ = ìœ ë™ìì‚° - ì´ë¶€ì±„
         * NCAV/ì£¼ = ìˆœìš´ì „ìë³¸ / ë°œí–‰ì£¼ì‹ìˆ˜
         */
        function calculateNetNet(currentAssets, totalLiabilities, sharesOutstanding) {
            if (!currentAssets || !totalLiabilities || !sharesOutstanding) return null;
            const netNet = currentAssets - totalLiabilities;
            return netNet / sharesOutstanding;
        }

        /**
         * 3. Peter Lynch - ì›”ê°€ì˜ ì˜ì›…
         * PEG = P/E ë¹„ìœ¨ / ì´ìµì„±ì¥ë¥ 
         * ì£¼ì‹ë¶„ë¥˜: ê³ ì„±ì¥ì£¼, ëŒ€í˜•ìš°ëŸ‰ì£¼, ì €ì„±ì¥ì£¼, ê²½ê¸°ìˆœí™˜ì£¼, í„´ì–´ë¼ìš´ë“œ
         */
        function calculatePEG(peRatio, earningsGrowthRate) {
            if (!peRatio || !earningsGrowthRate || earningsGrowthRate <= 0) return null;
            return peRatio / earningsGrowthRate;
        }

        function classifyLynchCategory(earningsGrowth, marketCap, dividendYield, isProfitable) {
            if (!isProfitable) return { category: 'í„´ì–´ë¼ìš´ë“œ', class: 'lynch-turnaround', desc: 'ì ìì—ì„œ í‘ì ì „í™˜ ê¸°ëŒ€' };
            if (earningsGrowth >= 20) return { category: 'ê³ ì„±ì¥ì£¼', class: 'lynch-fast', desc: 'ì—° 20% ì´ìƒ ì„±ì¥' };
            if (earningsGrowth >= 10 && marketCap > 10e9) return { category: 'ëŒ€í˜•ìš°ëŸ‰ì£¼', class: 'lynch-stalwart', desc: 'ì•ˆì •ì  10-20% ì„±ì¥' };
            if (earningsGrowth < 10 && dividendYield > 3) return { category: 'ì €ì„±ì¥ì£¼', class: 'lynch-slow', desc: 'ë‚®ì€ ì„±ì¥, ë†’ì€ ë°°ë‹¹' };
            return { category: 'ê²½ê¸°ìˆœí™˜ì£¼', class: 'lynch-cyclical', desc: 'ê²½ê¸°ì— ë”°ë¼ ì‹¤ì  ë³€ë™' };
        }

        /**
         * 4. Joel Greenblatt - ë§ˆë²•ì˜ ê³µì‹
         * ë§ˆë²• ê³µì‹ = ì´ìµìˆ˜ìµë¥  ìˆœìœ„ + ìë³¸ìˆ˜ìµë¥  ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)
         */
        function calculateEarningsYield(ebit, enterpriseValue) {
            if (!ebit || !enterpriseValue || enterpriseValue <= 0) return null;
            return (ebit / enterpriseValue) * 100;
        }

        function calculateROC(ebit, workingCapital, fixedAssets) {
            if (!ebit || (!workingCapital && !fixedAssets)) return null;
            const capital = (workingCapital || 0) + (fixedAssets || 0);
            if (capital <= 0) return null;
            return (ebit / capital) * 100;
        }

        /**
         * 5. William O'Neil - CAN SLIM
         */
        function calculateCANSLIMScore(metrics) {
            let score = 0;
            if (metrics.quarterlyEarningsGrowth > 25) score += 15;
            else if (metrics.quarterlyEarningsGrowth > 15) score += 10;
            if (metrics.annualEarningsGrowth > 25) score += 15;
            else if (metrics.annualEarningsGrowth > 15) score += 10;
            if (metrics.isNearHigh) score += 10;
            if (metrics.hasNewProduct) score += 10;
            if (metrics.relativeStrength > 80) score += 15;
            else if (metrics.relativeStrength > 60) score += 10;
            if (metrics.institutionalOwnership > 30) score += 10;
            if (metrics.marketTrend === 'up') score += 15;
            return Math.min(score, 100);
        }

        /**
         * 6. Harry Markowitz - í˜„ëŒ€í¬íŠ¸í´ë¦¬ì˜¤ì´ë¡ 
         */
        function calculatePortfolioStats(holdings, correlationMatrix) {
            const n = holdings.length;
            if (n === 0) return { volatility: 0, diversificationRatio: 0 };
            const returns = holdings.map(h => h.gain_loss_pct || 0);
            const weights = holdings.map(h => h.weight / 100);
            const portfolioReturn = returns.reduce((sum, r, i) => sum + r * weights[i], 0);
            const avgVolatility = holdings.reduce((sum, h) => sum + (h.volatility || 20), 0) / n;
            const diversificationRatio = Math.sqrt(n) / n * 100;
            return {
                portfolioReturn,
                avgVolatility,
                diversificationRatio: Math.min(diversificationRatio * 2, 100)
            };
        }

        function calculateSharpeRatio(portfolioReturn, riskFreeRate, volatility) {
            if (!volatility || volatility === 0) return null;
            return (portfolioReturn - riskFreeRate) / volatility;
        }

        /**
         * 7. ì¼ˆë¦¬ ê³µì‹ - Fortune's Formula
         */
        function calculateKellyPercent(winRate, avgWin, avgLoss) {
            if (!winRate || !avgWin || !avgLoss || avgLoss === 0) return null;
            const R = avgWin / Math.abs(avgLoss);
            const kelly = winRate - ((1 - winRate) / R);
            return Math.max(0, Math.min(kelly * 100, 100));
        }

        /**
         * 8. Ray Dalio - ì˜¬ì›¨ë” í¬íŠ¸í´ë¦¬ì˜¤
         */
        function calculateRiskContribution(holdings) {
            const totalVolatility = holdings.reduce((sum, h) => {
                return sum + (h.weight / 100) * (h.volatility || 20);
            }, 0);
            return holdings.map(h => {
                const contribution = ((h.weight / 100) * (h.volatility || 20)) / totalVolatility * 100;
                return {
                    symbol: h.symbol,
                    riskContribution: contribution,
                    weight: h.weight,
                    isOverweight: contribution > h.weight * 1.5
                };
            });
        }

        function analyzeEconomicSeasons(holdings) {
            const categories = { growth: 0, inflation: 0, deflation: 0, recession: 0 };
            holdings.forEach(h => {
                const weight = h.weight;
                if (h.sector === 'Technology' || h.sector === 'Consumer Discretionary') {
                    categories.growth += weight;
                } else if (h.sector === 'Energy' || h.sector === 'Materials') {
                    categories.inflation += weight;
                } else if (h.sector === 'Utilities' || h.sector === 'Consumer Staples') {
                    categories.recession += weight;
                } else {
                    categories.growth += weight * 0.5;
                    categories.recession += weight * 0.5;
                }
            });
            return categories;
        }

        /**
         * 9. Howard Marks - íˆ¬ìì— ëŒ€í•œ ìƒê°
         */
        function calculateRiskScore(metrics) {
            let riskScore = 50;
            if (metrics.peRatio > 30) riskScore += 15;
            else if (metrics.peRatio > 20) riskScore += 5;
            else if (metrics.peRatio < 10) riskScore -= 10;
            if (metrics.volatility > 40) riskScore += 15;
            else if (metrics.volatility > 25) riskScore += 5;
            if (metrics.weight > 20) riskScore += 10;
            if (metrics.priceVs52WeekHigh > 0.9) riskScore += 10;
            if (metrics.priceVs52WeekLow < 1.1) riskScore += 5;
            return Math.min(100, Math.max(0, riskScore));
        }

        /**
         * 10. Philip Fisher - ìœ„ëŒ€í•œ ê¸°ì—…ì— íˆ¬ìí•˜ë¼
         */
        function calculateFisherScore(qualitativeMetrics) {
            const checklist = [
                qualitativeMetrics.hasGrowthPotential,
                qualitativeMetrics.hasRnDCommitment,
                qualitativeMetrics.hasSalesOrganization,
                qualitativeMetrics.hasProfitMargin,
                qualitativeMetrics.improvingProfitMargin,
                qualitativeMetrics.hasGoodLaborRelations,
                qualitativeMetrics.hasGoodExecutives,
                qualitativeMetrics.hasDepthInManagement,
                qualitativeMetrics.hasCostAnalysis,
                qualitativeMetrics.hasIndustryPosition,
                qualitativeMetrics.hasLongTermOutlook,
                qualitativeMetrics.willDilute,
                qualitativeMetrics.managementTalks,
                qualitativeMetrics.hasIntegrity,
                qualitativeMetrics.salesGrowthPotential
            ];
            const score = checklist.filter(Boolean).length;
            return (score / 15) * 100;
        }

        /**
         * 11. Charlie Munger - ë©˜íƒˆ ëª¨ë¸
         * ì—­ë°œìƒ ì ìˆ˜: ì‹œì¥ê³¼ ë°˜ëŒ€ë¡œ ìƒê°í•˜ê¸°
         */
        function calculateMungerScore(metrics) {
            let score = 50;
            // ì—­ë°œìƒ: ëª¨ë‘ê°€ ì‹«ì–´í•  ë•Œ ì‚¬ê¸°
            if (metrics.sentiment < 30 && metrics.fundamentals > 60) score += 25;
            // ë³µë¦¬ì˜ í˜ ì´í•´
            if (metrics.roic > 15) score += 15;
            // ì§€ì†ì  ê²½ìŸìš°ìœ„ (moat)
            if (metrics.hasMoat) score += 20;
            // ê²½ì˜ì§„ í’ˆì§ˆ
            if (metrics.managementQuality > 70) score += 10;
            return Math.min(100, score);
        }

        /**
         * 12. John Bogle - ì¸ë±ìŠ¤ íˆ¬ì
         * ë¹„ìš© íš¨ìœ¨ì„± ë° ë¶„ì‚°
         */
        function calculateBogleScore(metrics) {
            let score = 50;
            // ë‚®ì€ ë¹„ìš©
            if (metrics.expenseRatio < 0.1) score += 20;
            else if (metrics.expenseRatio < 0.5) score += 10;
            // ë†’ì€ ë¶„ì‚°
            if (metrics.holdingsCount > 100) score += 20;
            else if (metrics.holdingsCount > 50) score += 10;
            // ì¥ê¸° ë³´ìœ 
            if (metrics.holdingPeriod > 5) score += 15;
            else if (metrics.holdingPeriod > 1) score += 5;
            return Math.min(100, score);
        }

        /**
         * 13. Burton Malkiel - ëœë¤ ì›Œí¬
         * íš¨ìœ¨ì  ì‹œì¥ ì§€í‘œ
         */
        function calculateMalkielScore(metrics) {
            // ê¸°ìˆ ì  ë¶„ì„ ì˜ì¡´ë„ ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ
            let score = 50;
            if (!metrics.usesTechnicalAnalysis) score += 15;
            // ë¶„ì‚° íˆ¬ì
            if (metrics.diversificationScore > 70) score += 20;
            // ë¹„ìš© íš¨ìœ¨ì„±
            if (metrics.tradingFrequency < 12) score += 15; // ì—° 12íšŒ ë¯¸ë§Œ ê±°ë˜
            return Math.min(100, score);
        }

        /**
         * 14. Nassim Taleb - ë¸”ë™ìŠ¤ì™„/ì•ˆí‹°í”„ë˜ì§ˆ
         * í…Œì¼ ë¦¬ìŠ¤í¬ ë° ì•ˆí‹°í”„ë˜ì§ˆ ì§€ìˆ˜
         */
        function calculateTalebScore(metrics) {
            let fragility = 50;

            // ë ˆë²„ë¦¬ì§€ê°€ ë†’ìœ¼ë©´ ì·¨ì•½
            if (metrics.debtToEquity > 2) fragility += 20;
            else if (metrics.debtToEquity > 1) fragility += 10;

            // ì§‘ì¤‘ë„ê°€ ë†’ìœ¼ë©´ ì·¨ì•½
            if (metrics.concentrationRisk > 30) fragility += 15;

            // ì˜µì…˜ì„±ì´ ìˆìœ¼ë©´ ì•ˆí‹°í”„ë˜ì§ˆ
            if (metrics.hasOptionality) fragility -= 20;

            // í˜„ê¸ˆì´ ì¶©ë¶„í•˜ë©´ ê°•ê±´
            if (metrics.cashRatio > 0.3) fragility -= 15;

            // ë¶„ë¥˜
            if (fragility >= 70) return { score: fragility, category: 'fragile', label: 'ì·¨ì•½', color: '#ef4444' };
            if (fragility >= 40) return { score: fragility, category: 'robust', label: 'ê°•ê±´', color: '#eab308' };
            return { score: fragility, category: 'antifragile', label: 'ì•ˆí‹°í”„ë˜ì§ˆ', color: '#22c55e' };
        }

        /**
         * 15. Seth Klarman - ì•ˆì „ë§ˆì§„ ì‹¬í™”
         * ê·¹ë‹¨ì  ê°€ì¹˜ íˆ¬ì
         */
        function calculateKlarmanScore(metrics) {
            let score = 0;
            // ë§¤ìš° ë³´ìˆ˜ì ì¸ ì•ˆì „ë§ˆì§„
            if (metrics.marginOfSafety > 50) score += 30;
            else if (metrics.marginOfSafety > 30) score += 20;
            else if (metrics.marginOfSafety > 0) score += 10;

            // ìˆ¨ê²¨ì§„ ìì‚°
            if (metrics.hasHiddenAssets) score += 20;

            // ì²­ì‚° ê°€ì¹˜
            if (metrics.priceToLiquidation < 1) score += 25;

            // ì¸ë‚´ì‹¬ (ì¥ê¸° ë³´ìœ )
            if (metrics.holdingPeriod > 3) score += 15;

            return Math.min(100, score);
        }

        /**
         * 16. Stanley Druckenmiller - íƒ‘ë‹¤ìš´ ë¶„ì„
         * ê±°ì‹œê²½ì œ í™˜ê²½ ì ìˆ˜
         */
        function calculateDruckenmillerScore(metrics) {
            let score = 50;

            // íŠ¸ë Œë“œ ë°©í–¥
            if (metrics.trendDirection === 'up') score += 15;
            else if (metrics.trendDirection === 'down') score -= 10;

            // ìœ ë™ì„± í™˜ê²½
            if (metrics.liquidityCondition === 'easy') score += 15;
            else if (metrics.liquidityCondition === 'tight') score -= 15;

            // ëª¨ë©˜í…€
            if (metrics.momentumScore > 70) score += 10;

            // í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ ì ì ˆì„±
            if (metrics.convictionLevel === 'high' && metrics.positionSize > 10) score += 10;

            return Math.min(100, Math.max(0, score));
        }

        // ============================================
        // ğŸ“Š ëŒ€ì‹œë³´ë“œ ë Œë”ë§
        // ============================================

        const app = document.getElementById('app');

        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                const data = await response.json();
                const enhancedData = enhanceWithBookMetrics(data);
                renderDashboard(enhancedData);
            } catch (error) {
                renderWelcome();
            }
        }

        function enhanceWithBookMetrics(data) {
            const { holdings, summary } = data;

            holdings.forEach(h => {
                h.weight = (h.market_value / summary.total_value) * 100;
            });

            holdings.forEach(h => {
                h.peRatio = Math.random() * 40 + 5;
                h.earningsGrowth = Math.random() * 30 - 5;
                h.volatility = Math.random() * 30 + 10;
                h.eps = h.current_price / (h.peRatio || 15);
                h.bookValue = h.current_price * (0.3 + Math.random() * 0.5);
                h.dividendYield = Math.random() * 3;
                h.relativeStrength = 30 + Math.random() * 60;
                h.debtToEquity = Math.random() * 2;
                h.roic = 5 + Math.random() * 20;

                h.grahamNumber = calculateGrahamNumber(h.eps, h.bookValue);
                h.marginOfSafety = calculateMarginOfSafety(h.grahamNumber, h.current_price);

                h.lynchCategory = classifyLynchCategory(
                    h.earningsGrowth,
                    10e9,
                    h.dividendYield,
                    h.eps > 0
                );

                h.pegRatio = calculatePEG(h.peRatio, Math.max(h.earningsGrowth, 1));

                h.earningsYield = 5 + Math.random() * 15;
                h.roc = 10 + Math.random() * 25;

                h.riskScore = calculateRiskScore({
                    peRatio: h.peRatio,
                    volatility: h.volatility,
                    weight: h.weight,
                    priceVs52WeekHigh: 0.85 + Math.random() * 0.15,
                    priceVs52WeekLow: 1 + Math.random() * 0.5
                });

                // ì¶”ê°€ ì§€í‘œ
                h.talebScore = calculateTalebScore({
                    debtToEquity: h.debtToEquity,
                    concentrationRisk: h.weight,
                    hasOptionality: Math.random() > 0.7,
                    cashRatio: Math.random() * 0.5
                });

                h.mungerScore = calculateMungerScore({
                    sentiment: 30 + Math.random() * 40,
                    fundamentals: 40 + Math.random() * 40,
                    roic: h.roic,
                    hasMoat: Math.random() > 0.5,
                    managementQuality: 40 + Math.random() * 40
                });
            });

            const portfolioStats = calculatePortfolioStats(holdings);
            const riskContributions = calculateRiskContribution(holdings);
            const economicSeasons = analyzeEconomicSeasons(holdings);

            const kellyPercent = calculateKellyPercent(0.55, 15, 10);
            const sharpeRatio = calculateSharpeRatio(
                summary.total_gain_loss_pct,
                4.5,
                portfolioStats.avgVolatility
            );

            return {
                ...data,
                holdings,
                bookMetrics: {
                    portfolioStats,
                    riskContributions,
                    economicSeasons,
                    kellyPercent,
                    sharpeRatio,
                    avgMarginOfSafety: holdings.reduce((sum, h) => sum + (h.marginOfSafety || 0), 0) / holdings.length,
                    avgPEG: holdings.reduce((sum, h) => sum + (h.pegRatio || 0), 0) / holdings.length,
                    avgRiskScore: holdings.reduce((sum, h) => sum + (h.riskScore || 50), 0) / holdings.length,
                    concentrationRisk: Math.max(...holdings.map(h => h.weight)),
                    diversificationScore: portfolioStats.diversificationRatio
                }
            };
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getScoreClass(score) {
            if (score >= 80) return 'excellent';
            if (score >= 60) return 'good';
            if (score >= 40) return 'fair';
            if (score >= 20) return 'poor';
            return 'bad';
        }

        function getRiskLevel(score) {
            if (score >= 80) return { level: 5, label: 'ë§¤ìš° ë†’ìŒ' };
            if (score >= 60) return { level: 4, label: 'ë†’ìŒ' };
            if (score >= 40) return { level: 3, label: 'ë³´í†µ' };
            if (score >= 20) return { level: 2, label: 'ë‚®ìŒ' };
            return { level: 1, label: 'ë§¤ìš° ë‚®ìŒ' };
        }

        function getGradeClass(value, thresholds) {
            if (value >= thresholds.a) return 'grade-a';
            if (value >= thresholds.b) return 'grade-b';
            if (value >= thresholds.c) return 'grade-c';
            if (value >= thresholds.d) return 'grade-d';
            return 'grade-f';
        }

        function renderWelcome() {
            app.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h2>í¬íŠ¸í´ë¦¬ì˜¤ ì§€ë‹ˆì–´ìŠ¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
                    <p style="margin: 20px 0; color: rgba(255,255,255,0.6);">
                        16ê¶Œì˜ íˆ¬ì ëª…ì € ê¸°ë°˜ ê³ ê¸‰ ëŒ€ì‹œë³´ë“œ<br>
                        GitHub Actionsê°€ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                    </p>
                </div>
            `;
            app.classList.remove('loading');
        }

        // Store data globally for modal access
        let globalData = null;

        function renderDashboard(data) {
            globalData = data;
            const { summary, holdings, last_updated, bookMetrics } = data;
            const gainClass = summary.total_gain_loss >= 0 ? 'positive' : 'negative';
            const riskLevel = getRiskLevel(bookMetrics.avgRiskScore);

            app.classList.remove('loading');
            app.innerHTML = `
                <header>
                    <div class="header-content">
                        <div class="logo">ğŸ“ˆ ì£¼ì‹ í¬íŠ¸í´ë¦¬ì˜¤ ì§€ë‹ˆì–´ìŠ¤</div>
                        <nav class="nav-links">
                            <a href="index.html" class="active">í¬íŠ¸í´ë¦¬ì˜¤</a>
                            <a href="battle.html">AI ëŒ€ê²°</a>
                            <a href="screener.html">ìŠ¤í¬ë¦¬ë„ˆ</a>
                            <a href="ideas.html">íˆ¬ìì•„ì´ë””ì–´</a>
                            <a href="history.html">ê±°ë˜ë‚´ì—­</a>
                            <a href="manage.html">ê´€ë¦¬</a>
                            <a href="guide.html">ê°€ì´ë“œ</a>
                        </nav>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="last-updated">ì—…ë°ì´íŠ¸: ${formatDate(last_updated)}</div>
                            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </div>
                </header>

                <main>
                    <!-- ìš”ì•½ ì¹´ë“œ -->
                    <div class="summary-grid">
                        <div class="summary-card highlight">
                            <div class="label">ì´ í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜</div>
                            <div class="value">${formatCurrency(summary.total_value)}</div>
                            <div class="change ${gainClass}">
                                ${formatCurrency(summary.total_gain_loss)} (${formatPercent(summary.total_gain_loss_pct)})
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ìƒ¤í”„ ë¹„ìœ¨ <span class="book-ref">ë§ˆì½”ìœ„ì¸ </span></div>
                            <div class="value ${bookMetrics.sharpeRatio >= 1 ? 'positive' : bookMetrics.sharpeRatio >= 0.5 ? 'neutral' : 'negative'}">
                                ${bookMetrics.sharpeRatio?.toFixed(2) || 'N/A'}
                            </div>
                            <div class="tooltip">ìœ„í—˜ì¡°ì •ìˆ˜ìµë¥  (1 ì´ìƒ = ì–‘í˜¸)</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">í‰ê·  PEG <span class="book-ref">í”¼í„° ë¦°ì¹˜</span></div>
                            <div class="value ${bookMetrics.avgPEG <= 1 ? 'positive' : bookMetrics.avgPEG <= 2 ? 'neutral' : 'negative'}">
                                ${bookMetrics.avgPEG?.toFixed(2) || 'N/A'}
                            </div>
                            <div class="tooltip">PEG < 1 = ì €í‰ê°€</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ì•ˆì „ë§ˆì§„ <span class="book-ref">ê·¸ë ˆì´ì—„</span></div>
                            <div class="value ${bookMetrics.avgMarginOfSafety >= 0 ? 'positive' : 'negative'}">
                                ${bookMetrics.avgMarginOfSafety?.toFixed(1) || 'N/A'}%
                            </div>
                            <div class="tooltip">ë†’ì„ìˆ˜ë¡ ì•ˆì „</div>
                        </div>

                        <div class="summary-card ${riskLevel.level >= 4 ? 'danger' : riskLevel.level >= 3 ? 'warning' : ''}">
                            <div class="label">ìœ„í—˜ ì ìˆ˜ <span class="book-ref">í•˜ì›Œë“œ ë§‰ìŠ¤</span></div>
                            <div class="value">${bookMetrics.avgRiskScore?.toFixed(0) || 'N/A'}</div>
                            <div class="risk-meter">
                                ${[1,2,3,4,5].map(i => `
                                    <div class="risk-bar ${i <= riskLevel.level ? 'active' : ''}"></div>
                                `).join('')}
                            </div>
                            <div class="tooltip">${riskLevel.label}</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ì¼ˆë¦¬ ìµœì  ë¹„ì¤‘ <span class="book-ref">ì¼ˆë¦¬ ê³µì‹</span></div>
                            <div class="value">${bookMetrics.kellyPercent?.toFixed(1) || 'N/A'}%</div>
                            <div class="tooltip">ìµœì  í¬ì§€ì…˜ í¬ê¸°</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ë¶„ì‚°í™” ì ìˆ˜ <span class="book-ref">ë§ˆì½”ìœ„ì¸ </span></div>
                            <div class="value">${bookMetrics.diversificationScore?.toFixed(0) || 'N/A'}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${bookMetrics.diversificationScore || 0}%; background: #4ade80;"></div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ë³´ìœ  ì¢…ëª©</div>
                            <div class="value">${summary.holdings_count}</div>
                            <div class="tooltip">ìµœëŒ€ ì§‘ì¤‘ë„: ${bookMetrics.concentrationRisk?.toFixed(1)}%</div>
                        </div>
                    </div>

                    <!-- íˆ¬ì ì¸ì‚¬ì´íŠ¸ -->
                    <div class="chart-container">
                        <h3 class="section-title collapsible-header" onclick="toggleSection(this)">
                            ğŸ§  íˆ¬ì ì¸ì‚¬ì´íŠ¸
                            <span class="section-subtitle">16ê¶Œì˜ íˆ¬ì ëª…ì € ê¸°ë°˜ ë¶„ì„</span>
                        </h3>
                        <div class="collapsible-content">
                            <div class="two-col-grid" style="margin-top: 15px;">
                                ${generateInsights(data, bookMetrics)}
                            </div>
                        </div>
                    </div>

                    <!-- ë³´ìœ  ì¢…ëª© í…Œì´ë¸” -->
                    <h2 class="section-title">ğŸ“Š ë³´ìœ  ì¢…ëª© ë¶„ì„ <span class="section-subtitle">í´ë¦­í•˜ì—¬ ìƒì„¸ ë¶„ì„ ë³´ê¸°</span></h2>
                    <div class="holdings-container">
                        <table class="holdings-table">
                            <thead>
                                <tr>
                                    <th>ì¢…ëª©</th>
                                    <th>ë¶„ë¥˜<br><small>ë¦°ì¹˜</small></th>
                                    <th>ë¹„ì¤‘</th>
                                    <th>í˜„ì¬ê°€</th>
                                    <th>P/E</th>
                                    <th>PEG<br><small>ë¦°ì¹˜</small></th>
                                    <th>ê·¸ë ˆì´ì—„#<br><small>ê·¸ë ˆì´ì—„</small></th>
                                    <th>ì•ˆì „ë§ˆì§„<br><small>ê·¸ë ˆì´ì—„</small></th>
                                    <th>ìœ„í—˜<br><small>ë§‰ìŠ¤</small></th>
                                    <th>ì†ìµ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${holdings.map((h, idx) => {
                                    const mosClass = (h.marginOfSafety || 0) >= 0 ? 'positive' : 'negative';
                                    const pegClass = (h.pegRatio || 99) <= 1 ? 'positive' : (h.pegRatio <= 2 ? 'neutral' : 'negative');
                                    const riskClass = getScoreClass(100 - h.riskScore);

                                    return `
                                    <tr onclick="openStockModal(${idx})">
                                        <td class="symbol-cell">
                                            ${h.symbol}
                                            <div class="symbol-name">${h.name}</div>
                                        </td>
                                        <td>
                                            <span class="lynch-category ${h.lynchCategory.class}">
                                                ${h.lynchCategory.category}
                                            </span>
                                        </td>
                                        <td>${h.weight.toFixed(1)}%</td>
                                        <td>${formatCurrency(h.current_price)}</td>
                                        <td>${h.peRatio?.toFixed(1) || '-'}</td>
                                        <td class="${pegClass}">${h.pegRatio?.toFixed(2) || '-'}</td>
                                        <td>${h.grahamNumber ? formatCurrency(h.grahamNumber) : '-'}</td>
                                        <td class="${mosClass}">${h.marginOfSafety?.toFixed(1) || '-'}%</td>
                                        <td>
                                            <span class="score-badge ${riskClass}">${h.riskScore?.toFixed(0) || '-'}</span>
                                        </td>
                                        <td class="${h.gain_loss >= 0 ? 'positive' : 'negative'}">
                                            ${formatCurrency(h.gain_loss)}<br>
                                            <small>${formatPercent(h.gain_loss_pct)}</small>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
                    <div class="three-col-grid">
                        <div class="chart-container">
                            <h3 class="section-title">
                                ğŸŒ¤ï¸ ê²½ì œí™˜ê²½ ë…¸ì¶œë„
                                <span class="book-ref">ë ˆì´ ë‹¬ë¦¬ì˜¤</span>
                            </h3>
                            <div class="allocation-chart">
                                <canvas id="economicSeasonsChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h3 class="section-title">
                                âš–ï¸ ìœ„í—˜ ê¸°ì—¬ë„
                                <span class="book-ref">ë¦¬ìŠ¤í¬ íŒ¨ë¦¬í‹°</span>
                            </h3>
                            <div class="allocation-chart">
                                <canvas id="riskContributionChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h3 class="section-title">ğŸ¥§ í¬íŠ¸í´ë¦¬ì˜¤ ë°°ë¶„</h3>
                            <div class="allocation-chart">
                                <canvas id="allocationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜ íˆìŠ¤í† ë¦¬ -->
                    <div class="chart-container" id="historyChartContainer" style="display:none;">
                        <h3 class="section-title">ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜ ì¶”ì´</h3>
                        <div style="height: 300px;">
                            <canvas id="historyChart"></canvas>
                        </div>
                    </div>

                    <!-- ì ìš©ëœ íˆ¬ì ë°©ë²•ë¡  -->
                    <div class="analysis-panel">
                        <h3 class="section-title collapsible-header" onclick="toggleSection(this)">
                            ğŸ“š ì ìš©ëœ íˆ¬ì ë°©ë²•ë¡  (16ê¶Œ)
                        </h3>
                        <div class="collapsible-content">
                            <div class="four-col-grid" style="margin-top: 15px;">
                                ${renderBookReferences()}
                            </div>
                        </div>
                    </div>
                </main>

                <footer>
                    <p>ì£¼ì‹ í¬íŠ¸í´ë¦¬ì˜¤ ì§€ë‹ˆì–´ìŠ¤ | 16ê¶Œì˜ íˆ¬ì ëª…ì € ê¸°ë°˜ ê³ ê¸‰ ë¶„ì„</p>
                    <p>ê·¸ë ˆì´ì—„ â€¢ ë¦°ì¹˜ â€¢ ê·¸ë¦°ë¸”ë¼íŠ¸ â€¢ ì˜¤ë‹ â€¢ ë§ˆì½”ìœ„ì¸  â€¢ ë‹¬ë¦¬ì˜¤ â€¢ ë§‰ìŠ¤ â€¢ í”¼ì…” â€¢ ë©ê±° â€¢ íƒˆë ™</p>
                </footer>
            `;

            renderAllocationChart(holdings);
            renderEconomicSeasonsChart(bookMetrics.economicSeasons);
            renderRiskContributionChart(bookMetrics.riskContributions);
            renderPortfolioHistoryChart(data.portfolio_history);
        }

        function generateInsights(data, bookMetrics) {
            const insights = [];

            if (bookMetrics.avgMarginOfSafety < 0) {
                insights.push({
                    type: 'warning',
                    icon: 'âš ï¸',
                    title: 'ê·¸ë ˆì´ì—„: ìŒìˆ˜ ì•ˆì „ë§ˆì§„',
                    content: `í¬íŠ¸í´ë¦¬ì˜¤ê°€ í‰ê·  ë‚´ì¬ê°€ì¹˜ë³´ë‹¤ ${Math.abs(bookMetrics.avgMarginOfSafety).toFixed(1)}% ë†’ì€ ê°€ê²©ì— ê±°ë˜ë˜ê³  ìˆìŠµë‹ˆë‹¤. ê°€ì¹˜ì£¼ í¸ì… ë˜ëŠ” ë” ë‚˜ì€ ë§¤ìˆ˜ ì‹œì ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.`
                });
            } else {
                insights.push({
                    type: 'success',
                    icon: 'âœ…',
                    title: 'ê·¸ë ˆì´ì—„: ì–‘ìˆ˜ ì•ˆì „ë§ˆì§„',
                    content: `í¬íŠ¸í´ë¦¬ì˜¤ê°€ ${bookMetrics.avgMarginOfSafety.toFixed(1)}% ì•ˆì „ë§ˆì§„ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë²¤ìë¯¼ ê·¸ë ˆì´ì—„ì˜ ì›ì¹™ì— ë¶€í•©í•˜ëŠ” ì¢‹ì€ ê°€ì¹˜ í¬ì§€ì…”ë‹ì…ë‹ˆë‹¤.`
                });
            }

            if (bookMetrics.avgPEG > 2) {
                insights.push({
                    type: 'warning',
                    icon: 'ğŸ“Š',
                    title: 'ë¦°ì¹˜: ë†’ì€ PEG ë¹„ìœ¨',
                    content: `í‰ê·  PEG ${bookMetrics.avgPEG.toFixed(2)}ëŠ” ì„±ì¥ ëŒ€ë¹„ ë¹„ì‹¼ ê°€ê²©ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. í”¼í„° ë¦°ì¹˜ëŠ” PEG < 1ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`
                });
            }

            const maxRiskConcentration = Math.max(...bookMetrics.riskContributions.map(r => r.riskContribution));
            if (maxRiskConcentration > 30) {
                insights.push({
                    type: 'warning',
                    icon: 'âš–ï¸',
                    title: 'ë‹¬ë¦¬ì˜¤: ë¶ˆê· í˜• ë¦¬ìŠ¤í¬',
                    content: `í•œ ì¢…ëª©ì´ í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ì˜ ${maxRiskConcentration.toFixed(1)}%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤. ë ˆì´ ë‹¬ë¦¬ì˜¤ì˜ ë¦¬ìŠ¤í¬ íŒ¨ë¦¬í‹°ëŠ” ë” ê· í˜• ì¡íŒ ë¦¬ìŠ¤í¬ ë¶„ë°°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.`
                });
            }

            if (bookMetrics.sharpeRatio !== null && bookMetrics.sharpeRatio < 0.5) {
                insights.push({
                    type: 'warning',
                    icon: 'ğŸ“‰',
                    title: 'ë§ˆì½”ìœ„ì¸ : ë‚®ì€ ìœ„í—˜ì¡°ì •ìˆ˜ìµë¥ ',
                    content: `ìƒ¤í”„ ë¹„ìœ¨ ${bookMetrics.sharpeRatio.toFixed(2)}ëŠ” ìœ„í—˜ ëŒ€ë¹„ ë‚®ì€ ìˆ˜ìµì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë¦¬ë°¸ëŸ°ì‹±ì„ í†µí•´ íš¨ìœ¨ì„±ì„ ê°œì„ í•˜ì„¸ìš”.`
                });
            }

            if (bookMetrics.concentrationRisk > 25) {
                insights.push({
                    type: 'warning',
                    icon: 'ğŸ²',
                    title: 'ë§‰ìŠ¤: ì§‘ì¤‘ ë¦¬ìŠ¤í¬',
                    content: `ìµœëŒ€ í¬ì§€ì…˜ì´ ${bookMetrics.concentrationRisk.toFixed(1)}%ì…ë‹ˆë‹¤. í•˜ì›Œë“œ ë§‰ìŠ¤ëŠ” ì§‘ì¤‘ í¬ì§€ì…˜ì˜ ë¹„ëŒ€ì¹­ ë¦¬ìŠ¤í¬ì— ëŒ€í•´ ê²½ê³ í•©ë‹ˆë‹¤.`
                });
            }

            // íƒˆë ™ ì¸ì‚¬ì´íŠ¸
            insights.push({
                type: 'info',
                icon: 'ğŸ¦¢',
                title: 'íƒˆë ™: ë¸”ë™ìŠ¤ì™„ ëŒ€ë¹„',
                content: `ê·¹ë‹¨ì  ì‹œì¥ ì¶©ê²©ì— ëŒ€ë¹„í•˜ì„¸ìš”. ë ˆë²„ë¦¬ì§€ë¥¼ ë‚®ì¶”ê³  ì˜µì…˜ì„±(ì—…ì‚¬ì´ë“œ ì ì¬ë ¥)ì´ ìˆëŠ” í¬ì§€ì…˜ì„ ìœ ì§€í•˜ì„¸ìš”.`
            });

            return insights.map(i => `
                <div class="insight-card ${i.type === 'warning' ? 'warning' : ''}">
                    <div class="insight-title">${i.icon} ${i.title}</div>
                    <div class="insight-content">${i.content}</div>
                </div>
            `).join('');
        }

        function renderBookReferences() {
            const books = [
                { title: 'í˜„ëª…í•œ íˆ¬ìì', author: 'B. ê·¸ë ˆì´ì—„', metric: 'ì•ˆì „ë§ˆì§„, ê·¸ë ˆì´ì—„ ë„˜ë²„' },
                { title: 'ì¦ê¶Œë¶„ì„', author: 'ê·¸ë ˆì´ì—„ & ë„ë“œ', metric: 'ìˆœìˆœìì‚°ê°€ì¹˜, ê¸°ë³¸ì  ë¶„ì„' },
                { title: 'ì›”ê°€ì˜ ì˜ì›…', author: 'í”¼í„° ë¦°ì¹˜', metric: 'PEG ë¹„ìœ¨, ì£¼ì‹ ë¶„ë¥˜' },
                { title: 'ì‹œì¥ì„ ì´ê¸°ëŠ” ì‘ì€ ì±…', author: 'ì¡°ì—˜ ê·¸ë¦°ë¸”ë¼íŠ¸', metric: 'ë§ˆë²• ê³µì‹ (ROC + EY)' },
                { title: 'ì£¼ì‹ì‹œì¥ì—ì„œ ëˆë²„ëŠ” ë²•', author: 'ìœŒë¦¬ì—„ ì˜¤ë‹', metric: 'CAN SLIM ì ìˆ˜' },
                { title: 'í¬íŠ¸í´ë¦¬ì˜¤ ì„ íƒ', author: 'í•´ë¦¬ ë§ˆì½”ìœ„ì¸ ', metric: 'ìƒ¤í”„ ë¹„ìœ¨, ë¶„ì‚°í™”' },
                { title: 'í–‰ìš´ì˜ ê³µì‹', author: 'ìœŒë¦¬ì—„ íŒŒìš´ë“œìŠ¤í†¤', metric: 'ì¼ˆë¦¬ ê¸°ì¤€ %' },
                { title: 'ì›ì¹™ (ì˜¬ì›¨ë”)', author: 'ë ˆì´ ë‹¬ë¦¬ì˜¤', metric: 'ë¦¬ìŠ¤í¬ íŒ¨ë¦¬í‹°, ê²½ì œ ì‹œì¦Œ' },
                { title: 'íˆ¬ìì— ëŒ€í•œ ìƒê°', author: 'í•˜ì›Œë“œ ë§‰ìŠ¤', metric: 'ìœ„í—˜ ì ìˆ˜, ì‹œì¥ ì‚¬ì´í´' },
                { title: 'ìœ„ëŒ€í•œ ê¸°ì—…ì— íˆ¬ìí•˜ë¼', author: 'í•„ë¦½ í”¼ì…”', metric: 'ì •ì„±ì  ì²´í¬ë¦¬ìŠ¤íŠ¸' },
                { title: 'ê°€ë‚œí•œ ì°°ë¦¬ì˜ ì—°ê°', author: 'ì°°ë¦¬ ë©ê±°', metric: 'ë©˜íƒˆ ëª¨ë¸, ì—­ë°œìƒ' },
                { title: 'ëœë¤ì›Œí¬ íˆ¬ììˆ˜ì—…', author: 'ë²„íŠ¼ ë§í‚¤ì—˜', metric: 'íš¨ìœ¨ì  ì‹œì¥, ë¶„ì‚°' },
                { title: 'ë³´ê¸€ì˜ íˆ¬ì ì›ì¹™', author: 'ì¡´ ë³´ê¸€', metric: 'ì¸ë±ìŠ¤ íˆ¬ì, ë¹„ìš© íš¨ìœ¨' },
                { title: 'ë¸”ë™ ìŠ¤ì™„', author: 'ë‚˜ì‹¬ íƒˆë ™', metric: 'í…Œì¼ ë¦¬ìŠ¤í¬, ì•ˆí‹°í”„ë˜ì§ˆ' },
                { title: 'ì•ˆì „ë§ˆì§„', author: 'ì„¸ìŠ¤ í´ë¼ë§Œ', metric: 'ê·¹ë‹¨ì  ê°€ì¹˜íˆ¬ì' },
                { title: 'ìƒˆë¡œìš´ ì‹œì¥ì˜ ë§ˆë²•ì‚¬ë“¤', author: 'ì­ ìŠˆì›¨ê±°', metric: 'ë“œëŸ¬ì¼„ë°€ëŸ¬ íƒ‘ë‹¤ìš´' }
            ];

            return books.map(b => `
                <div class="analysis-panel" style="padding: 12px; margin-bottom: 0;">
                    <div style="font-weight: bold; font-size: 0.85rem; color: #4ade80;">${b.title}</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">${b.author}</div>
                    <div style="font-size: 0.75rem; margin-top: 5px;">${b.metric}</div>
                </div>
            `).join('');
        }

        // ============================================
        // ğŸ“± ì¢…ëª© ìƒì„¸ ëª¨ë‹¬
        // ============================================

        function openStockModal(idx) {
            if (!globalData) return;
            const h = globalData.holdings[idx];
            const modal = document.getElementById('stockModal');

            document.getElementById('modalSymbol').textContent = h.symbol;
            document.getElementById('modalName').textContent = h.name;

            const mosGrade = h.marginOfSafety >= 20 ? 'A' : h.marginOfSafety >= 0 ? 'B' : h.marginOfSafety >= -20 ? 'C' : 'D';
            const pegGrade = h.pegRatio <= 0.5 ? 'A' : h.pegRatio <= 1 ? 'B' : h.pegRatio <= 2 ? 'C' : 'D';
            const riskGrade = h.riskScore <= 30 ? 'A' : h.riskScore <= 50 ? 'B' : h.riskScore <= 70 ? 'C' : 'D';

            document.getElementById('modalBody').innerHTML = `
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="modal-section">
                    <div class="modal-section-title">ğŸ“Œ ê¸°ë³¸ ì •ë³´</div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">í˜„ì¬ê°€</div>
                            <div class="metric-value">${formatCurrency(h.current_price)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘</div>
                            <div class="metric-value">${h.weight.toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ì†ìµ</div>
                            <div class="metric-value ${h.gain_loss >= 0 ? 'positive' : 'negative'}">${formatCurrency(h.gain_loss)} (${formatPercent(h.gain_loss_pct)})</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ë¦°ì¹˜ ë¶„ë¥˜</div>
                            <div class="metric-value"><span class="lynch-category ${h.lynchCategory.class}">${h.lynchCategory.category}</span></div>
                            <div class="metric-desc">${h.lynchCategory.desc}</div>
                        </div>
                    </div>
                </div>

                <!-- ë²¤ìë¯¼ ê·¸ë ˆì´ì—„ ë¶„ì„ -->
                <div class="modal-section">
                    <div class="modal-section-title">ğŸ“– ë²¤ìë¯¼ ê·¸ë ˆì´ì—„ ë¶„ì„ <span class="book-ref">í˜„ëª…í•œ íˆ¬ìì</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ê·¸ë ˆì´ì—„ ë„˜ë²„</div>
                            <div class="metric-value">${h.grahamNumber ? formatCurrency(h.grahamNumber) : 'N/A'}</div>
                            <div class="formula-box">âˆš(22.5 Ã— EPS Ã— ì£¼ë‹¹ìˆœìì‚°)</div>
                            <div class="metric-desc">ê·¸ë ˆì´ì—„ ë„˜ë²„ëŠ” ì£¼ì‹ì˜ ìµœëŒ€ ì ì • ê°€ê²©ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. í˜„ì¬ê°€ê°€ ì´ë³´ë‹¤ ë‚®ìœ¼ë©´ ì €í‰ê°€ì…ë‹ˆë‹¤.</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ì•ˆì „ë§ˆì§„</div>
                            <div class="metric-value ${h.marginOfSafety >= 0 ? 'positive' : 'negative'}">${h.marginOfSafety?.toFixed(1)}%</div>
                            <div class="metric-desc">
                                <span class="analysis-grade grade-${mosGrade.toLowerCase()}">${mosGrade}ë“±ê¸‰</span>
                                ${h.marginOfSafety >= 0 ? 'âœ… ë‚´ì¬ê°€ì¹˜ ëŒ€ë¹„ ì €í‰ê°€' : 'âš ï¸ ë‚´ì¬ê°€ì¹˜ ëŒ€ë¹„ ê³ í‰ê°€'}
                            </div>
                            <div class="formula-box">(ë‚´ì¬ê°€ì¹˜ - í˜„ì¬ê°€) / ë‚´ì¬ê°€ì¹˜ Ã— 100</div>
                        </div>
                    </div>
                </div>

                <!-- í”¼í„° ë¦°ì¹˜ ë¶„ì„ -->
                <div class="modal-section">
                    <div class="modal-section-title">ğŸ“– í”¼í„° ë¦°ì¹˜ ë¶„ì„ <span class="book-ref">ì›”ê°€ì˜ ì˜ì›…</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">PEG ë¹„ìœ¨</div>
                            <div class="metric-value ${h.pegRatio <= 1 ? 'positive' : h.pegRatio <= 2 ? 'neutral' : 'negative'}">${h.pegRatio?.toFixed(2)}</div>
                            <div class="formula-box">P/E ë¹„ìœ¨ / ì´ìµì„±ì¥ë¥ </div>
                            <div class="metric-desc">
                                <span class="analysis-grade grade-${pegGrade.toLowerCase()}">${pegGrade}ë“±ê¸‰</span>
                                ${h.pegRatio <= 1 ? 'âœ… ì„±ì¥ ëŒ€ë¹„ ì €í‰ê°€ (ë¦°ì¹˜ ì¶”ì²œ)' : h.pegRatio <= 2 ? 'âš¡ ì ì • ìˆ˜ì¤€' : 'âš ï¸ ì„±ì¥ ëŒ€ë¹„ ê³ í‰ê°€'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">P/E ë¹„ìœ¨</div>
                            <div class="metric-value">${h.peRatio?.toFixed(1)}</div>
                            <div class="metric-desc">ì´ìµ ëŒ€ë¹„ ì£¼ê°€ ìˆ˜ì¤€. ë™ì¢… ì—…ê³„ í‰ê· ê³¼ ë¹„êµí•˜ì„¸ìš”.</div>
                        </div>
                    </div>
                </div>

                <!-- í•˜ì›Œë“œ ë§‰ìŠ¤ ë¶„ì„ -->
                <div class="modal-section">
                    <div class="modal-section-title">ğŸ“– í•˜ì›Œë“œ ë§‰ìŠ¤ ìœ„í—˜ ë¶„ì„ <span class="book-ref">íˆ¬ìì— ëŒ€í•œ ìƒê°</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ìœ„í—˜ ì ìˆ˜</div>
                            <div class="metric-value">${h.riskScore?.toFixed(0)} / 100</div>
                            <div class="risk-meter">
                                ${[1,2,3,4,5].map(i => `
                                    <div class="risk-bar ${i <= Math.ceil(h.riskScore / 20) ? 'active' : ''}"></div>
                                `).join('')}
                            </div>
                            <div class="metric-desc">
                                <span class="analysis-grade grade-${riskGrade.toLowerCase()}">${riskGrade}ë“±ê¸‰</span>
                                ë°¸ë¥˜ì—ì´ì…˜, ë³€ë™ì„±, ì§‘ì¤‘ë„ë¥¼ ì¢…í•©í•œ ìœ„í—˜ ì§€í‘œ
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ë³€ë™ì„±</div>
                            <div class="metric-value">${h.volatility?.toFixed(1)}%</div>
                            <div class="metric-desc">ê°€ê²© ë³€ë™í­. ë†’ì„ìˆ˜ë¡ ìœ„í—˜í•˜ì§€ë§Œ ê¸°íšŒë„ í¼.</div>
                        </div>
                    </div>
                </div>

                <!-- ë‚˜ì‹¬ íƒˆë ™ ë¶„ì„ -->
                <div class="modal-section">
                    <div class="modal-section-title">ğŸ“– ë‚˜ì‹¬ íƒˆë ™ ë¶„ì„ <span class="book-ref">ë¸”ë™ ìŠ¤ì™„ / ì•ˆí‹°í”„ë˜ì§ˆ</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">í”„ë˜ì§ˆë¦¬í‹° ì ìˆ˜</div>
                            <div class="metric-value" style="color: ${h.talebScore.color}">${h.talebScore.label}</div>
                            <div class="taleb-indicator">
                                <div class="taleb-block ${h.talebScore.category === 'fragile' ? 'fragile' : ''}"></div>
                                <div class="taleb-block ${h.talebScore.category === 'robust' ? 'robust' : ''}"></div>
                                <div class="taleb-block ${h.talebScore.category === 'antifragile' ? 'antifragile' : ''}"></div>
                            </div>
                            <div class="metric-desc">
                                ${h.talebScore.category === 'fragile' ? 'âš ï¸ ê·¹ë‹¨ì  ì¶©ê²©ì— ì·¨ì•½. ë ˆë²„ë¦¬ì§€ì™€ ì§‘ì¤‘ë„ë¥¼ ì¤„ì´ì„¸ìš”.' :
                                  h.talebScore.category === 'robust' ? 'âš¡ ì¶©ê²©ì— ê²¬ë”œ ìˆ˜ ìˆìŒ. í˜„ìƒ ìœ ì§€ ê°€ëŠ¥.' :
                                  'âœ… ë³€ë™ì„±ì—ì„œ ì´ìµì„ ì–»ì„ ìˆ˜ ìˆëŠ” êµ¬ì¡°'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ë¶€ì±„ë¹„ìœ¨</div>
                            <div class="metric-value">${(h.debtToEquity * 100).toFixed(0)}%</div>
                            <div class="metric-desc">ë†’ì€ ë ˆë²„ë¦¬ì§€ëŠ” í”„ë˜ì§ˆë¦¬í‹°ë¥¼ ë†’ì…ë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>

                <!-- ì°°ë¦¬ ë©ê±° ë¶„ì„ -->
                <div class="modal-section">
                    <div class="modal-section-title">ğŸ“– ì°°ë¦¬ ë©ê±° ë¶„ì„ <span class="book-ref">ê°€ë‚œí•œ ì°°ë¦¬ì˜ ì—°ê°</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ë©ê±° ì ìˆ˜</div>
                            <div class="metric-value">${h.mungerScore?.toFixed(0)} / 100</div>
                            <div class="metric-desc">ê²½ìŸìš°ìœ„(Moat), ROIC, ê²½ì˜ì§„ í’ˆì§ˆì„ ì¢…í•© í‰ê°€</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">íˆ¬í•˜ìë³¸ìˆ˜ìµë¥  (ROIC)</div>
                            <div class="metric-value ${h.roic > 15 ? 'positive' : h.roic > 10 ? 'neutral' : 'negative'}">${h.roic?.toFixed(1)}%</div>
                            <div class="metric-desc">${h.roic > 15 ? 'âœ… ë›°ì–´ë‚œ ìë³¸ íš¨ìœ¨ì„±' : h.roic > 10 ? 'âš¡ ì–‘í˜¸í•œ ìˆ˜ì¤€' : 'âš ï¸ ìë³¸ íš¨ìœ¨ì„± ê°œì„  í•„ìš”'}</div>
                        </div>
                    </div>
                </div>

                <!-- ë§ˆë²• ê³µì‹ ë¶„ì„ -->
                <div class="modal-section">
                    <div class="modal-section-title">ğŸ“– ê·¸ë¦°ë¸”ë¼íŠ¸ ë§ˆë²• ê³µì‹ <span class="book-ref">ì‹œì¥ì„ ì´ê¸°ëŠ” ì‘ì€ ì±…</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ì´ìµìˆ˜ìµë¥  (Earnings Yield)</div>
                            <div class="metric-value">${h.earningsYield?.toFixed(1)}%</div>
                            <div class="formula-box">EBIT / ê¸°ì—…ê°€ì¹˜</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ìë³¸ìˆ˜ìµë¥  (ROC)</div>
                            <div class="metric-value">${h.roc?.toFixed(1)}%</div>
                            <div class="formula-box">EBIT / (ìˆœìš´ì „ìë³¸ + ê³ ì •ìì‚°)</div>
                        </div>
                    </div>
                </div>

                <!-- íˆ¬ì ê¶Œì¥ì‚¬í•­ -->
                <div class="recommendation-box">
                    <div class="recommendation-title">ğŸ’¡ ì¢…í•© íˆ¬ì ê¶Œì¥ì‚¬í•­</div>
                    <ul class="recommendation-list">
                        ${generateRecommendations(h)}
                    </ul>
                </div>
            `;

            modal.classList.add('active');
        }

        function generateRecommendations(h) {
            const recs = [];

            if (h.marginOfSafety < -30) {
                recs.push(`ê·¸ë ˆì´ì—„ ê´€ì : í˜„ì¬ê°€ê°€ ë‚´ì¬ê°€ì¹˜ë³´ë‹¤ ${Math.abs(h.marginOfSafety).toFixed(0)}% ë†’ìŠµë‹ˆë‹¤. ë§¤ìˆ˜ë³´ë‹¤ ê´€ë§ ê¶Œì¥.`);
            } else if (h.marginOfSafety > 20) {
                recs.push(`ê·¸ë ˆì´ì—„ ê´€ì : ${h.marginOfSafety.toFixed(0)}% ì•ˆì „ë§ˆì§„ìœ¼ë¡œ ë§¤ë ¥ì ì¸ ê°€ì¹˜ì£¼ì…ë‹ˆë‹¤.`);
            }

            if (h.pegRatio <= 1) {
                recs.push(`ë¦°ì¹˜ ê´€ì : PEG ${h.pegRatio.toFixed(2)}ë¡œ ì„±ì¥ ëŒ€ë¹„ ì €í‰ê°€. ì¶”ê°€ ë§¤ìˆ˜ ê³ ë ¤.`);
            } else if (h.pegRatio > 2.5) {
                recs.push(`ë¦°ì¹˜ ê´€ì : PEG ${h.pegRatio.toFixed(2)}ë¡œ ì„±ì¥ ëŒ€ë¹„ ê³ í‰ê°€. ë¹„ì¤‘ ì¶•ì†Œ ê²€í† .`);
            }

            if (h.weight > 25) {
                recs.push(`ë§‰ìŠ¤ ê´€ì : ${h.weight.toFixed(1)}% ì§‘ì¤‘ë„ëŠ” ë¹„ëŒ€ì¹­ ë¦¬ìŠ¤í¬ë¥¼ ì´ˆë˜. ë¶„ì‚° í•„ìš”.`);
            }

            if (h.talebScore.category === 'fragile') {
                recs.push(`íƒˆë ™ ê´€ì : ë¸”ë™ìŠ¤ì™„ ì´ë²¤íŠ¸ì— ì·¨ì•½. í—¤ì§€ ì „ëµ ë˜ëŠ” í¬ì§€ì…˜ ì¶•ì†Œ ê¶Œì¥.`);
            }

            if (h.roic > 20) {
                recs.push(`ë©ê±° ê´€ì : ë›°ì–´ë‚œ ROIC(${h.roic.toFixed(1)}%)ëŠ” ê²½ìŸìš°ìœ„ì˜ ì¦ê±°. ì¥ê¸° ë³´ìœ  ì í•©.`);
            }

            if (recs.length === 0) {
                recs.push('ì¢…í•©ì ìœ¼ë¡œ í˜„ì¬ í¬ì§€ì…˜ ìœ ì§€ê°€ ì ì ˆí•´ ë³´ì…ë‹ˆë‹¤. ì •ê¸°ì ìœ¼ë¡œ ì¬í‰ê°€í•˜ì„¸ìš”.');
            }

            return recs.map(r => `<li>${r}</li>`).join('');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        function closeModalOnOverlay(event) {
            if (event.target === document.getElementById('stockModal')) {
                closeStockModal();
            }
        }

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeStockModal();
            }
        });

        // ============================================
        // ğŸ“Š ì°¨íŠ¸ ë Œë”ë§
        // ============================================

        function renderAllocationChart(holdings) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            const colors = ['#4ade80', '#60a5fa', '#f472b6', '#facc15', '#a78bfa', '#fb923c', '#2dd4bf', '#f87171', '#818cf8', '#34d399', '#fbbf24', '#f43f5e'];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: holdings.map(h => h.symbol),
                    datasets: [{
                        data: holdings.map(h => h.market_value),
                        backgroundColor: colors.slice(0, holdings.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#fff', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderEconomicSeasonsChart(seasons) {
            const ctx = document.getElementById('economicSeasonsChart').getContext('2d');

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ì„±ì¥ ìƒìŠ¹', 'ì¸í”Œë ˆì´ì…˜ ìƒìŠ¹', 'ì„±ì¥ í•˜ë½', 'ì¸í”Œë ˆì´ì…˜ í•˜ë½'],
                    datasets: [{
                        label: 'í¬íŠ¸í´ë¦¬ì˜¤ ë…¸ì¶œë„',
                        data: [seasons.growth, seasons.inflation, seasons.recession, seasons.deflation],
                        backgroundColor: 'rgba(74, 222, 128, 0.2)',
                        borderColor: '#4ade80',
                        borderWidth: 2,
                        pointBackgroundColor: '#4ade80'
                    }, {
                        label: 'ì´ìƒì  (ê° 25%)',
                        data: [25, 25, 25, 25],
                        backgroundColor: 'rgba(255, 255, 255, 0.05)',
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointBackgroundColor: 'rgba(255, 255, 255, 0.3)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 9 } },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#fff', font: { size: 10 } }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderRiskContributionChart(riskContributions) {
            const ctx = document.getElementById('riskContributionChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: riskContributions.map(r => r.symbol),
                    datasets: [{
                        label: 'ìœ„í—˜ ê¸°ì—¬ë„ %',
                        data: riskContributions.map(r => r.riskContribution),
                        backgroundColor: riskContributions.map(r =>
                            r.isOverweight ? '#ef4444' : '#4ade80'
                        ),
                        borderRadius: 4
                    }, {
                        label: 'ë¹„ì¤‘ %',
                        data: riskContributions.map(r => r.weight),
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.6)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 9 } },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderPortfolioHistoryChart(portfolioHistory) {
            if (!portfolioHistory || portfolioHistory.length < 2) {
                return;
            }

            document.getElementById('historyChartContainer').style.display = 'block';
            const ctx = document.getElementById('historyChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: portfolioHistory.map(d => d.date),
                    datasets: [{
                        label: 'í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜',
                        data: portfolioHistory.map(d => d.total_value),
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        fill: true,
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#4ade80'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => formatCurrency(ctx.raw)
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.6)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255,255,255,0.6)',
                                callback: value => '$' + value.toLocaleString()
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
        }
    </script>
</body>
</html>
