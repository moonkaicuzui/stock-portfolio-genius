<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Ï£ºÏãù Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏßÄÎãàÏñ¥Ïä§ - Í≥†Í∏â Ìà¨Ïûê ÎåÄÏãúÎ≥¥Îìú</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 40px;
            width: 350px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .login-box h1 {
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .login-box p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
        }

        .login-input:focus {
            outline: none;
            border-color: #4ade80;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 222, 128, 0.3);
        }

        .login-error {
            color: #f87171;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.5rem;
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #ffffff33;
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .last-updated {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #f87171;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-card.highlight {
            border-color: #4ade80;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }

        .summary-card.warning {
            border-color: #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }

        .summary-card.danger {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        .summary-card .label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .summary-card .change {
            font-size: 0.9rem;
            margin-top: 6px;
        }

        .summary-card .tooltip {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        .neutral { color: #fbbf24; }

        /* Section Title */
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: normal;
        }

        /* Book Reference Badge */
        .book-ref {
            display: inline-block;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            margin-left: 8px;
            font-weight: normal;
        }

        /* Holdings Table */
        .holdings-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .holdings-table th,
        .holdings-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .holdings-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            text-transform: uppercase;
            position: sticky;
            top: 0;
        }

        .holdings-table tr {
            cursor: pointer;
            transition: all 0.2s;
        }

        .holdings-table tr:hover {
            background: rgba(74, 222, 128, 0.1);
            transform: scale(1.01);
        }

        .symbol-cell {
            font-weight: bold;
            font-size: 1rem;
        }

        .symbol-name {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            font-weight: normal;
        }

        /* Score Badges */
        .score-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .score-badge.excellent { background: #22c55e; color: #000; }
        .score-badge.good { background: #84cc16; color: #000; }
        .score-badge.fair { background: #eab308; color: #000; }
        .score-badge.poor { background: #f97316; color: #000; }
        .score-badge.bad { background: #ef4444; color: #fff; }

        /* Lynch Category */
        .lynch-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .lynch-fast { background: #8b5cf6; color: #fff; }
        .lynch-stalwart { background: #3b82f6; color: #fff; }
        .lynch-slow { background: #6b7280; color: #fff; }
        .lynch-cyclical { background: #f59e0b; color: #000; }
        .lynch-turnaround { background: #ef4444; color: #fff; }
        .lynch-asset { background: #10b981; color: #fff; }

        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        /* Grid Layouts */
        .two-col-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .three-col-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .four-col-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .three-col-grid { grid-template-columns: 1fr 1fr; }
            .four-col-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .two-col-grid, .three-col-grid, .four-col-grid {
                grid-template-columns: 1fr;
            }
            .holdings-table {
                display: block;
                overflow-x: auto;
            }
            .summary-card .value {
                font-size: 1.3rem;
            }
        }

        .allocation-chart {
            height: 250px;
        }

        /* Analysis Panel */
        .analysis-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .analysis-value {
            font-weight: bold;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Risk Meter */
        .risk-meter {
            display: flex;
            gap: 3px;
            margin-top: 8px;
        }

        .risk-bar {
            flex: 1;
            height: 20px;
            border-radius: 3px;
            opacity: 0.3;
        }

        .risk-bar.active {
            opacity: 1;
        }

        .risk-bar:nth-child(1) { background: #22c55e; }
        .risk-bar:nth-child(2) { background: #84cc16; }
        .risk-bar:nth-child(3) { background: #eab308; }
        .risk-bar:nth-child(4) { background: #f97316; }
        .risk-bar:nth-child(5) { background: #ef4444; }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.85rem;
        }

        footer a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Insight Cards */
        .insight-card {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .insight-card.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1));
            border-color: rgba(245, 158, 11, 0.3);
        }

        .insight-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-content {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Collapsible Section */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header::after {
            content: '‚ñº';
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .collapsible-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .modal-symbol {
            color: #4ade80;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .metric-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
            line-height: 1.4;
        }

        .formula-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #4ade80;
            margin-top: 10px;
        }

        .analysis-grade {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .grade-a { background: #22c55e; color: #000; }
        .grade-b { background: #84cc16; color: #000; }
        .grade-c { background: #eab308; color: #000; }
        .grade-d { background: #f97316; color: #000; }
        .grade-f { background: #ef4444; color: #fff; }

        .recommendation-box {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(59, 130, 246, 0.15));
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .recommendation-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #4ade80;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .recommendation-list li:last-child {
            border-bottom: none;
        }

        .recommendation-list li::before {
            content: 'üí°';
        }

        /* Taleb Risk Indicator */
        .taleb-indicator {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-top: 8px;
        }

        .taleb-block {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .taleb-block.fragile { background: #ef4444; }
        .taleb-block.robust { background: #eab308; }
        .taleb-block.antifragile { background: #22c55e; }

        /* Insight Modal Styles */
        .insight-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .insight-trigger {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .insight-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74, 222, 128, 0.2);
        }

        .insight-trigger::after {
            content: 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏Î≥¥Í∏∞ ‚Üí';
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .market-outlook-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .market-outlook-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .market-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .market-card .market-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }

        .market-card .market-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .market-card .market-status {
            font-size: 0.75rem;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .market-status.bullish { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .market-status.bearish { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .market-status.neutral { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .market-status.caution { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

        .market-opinion-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .market-opinion-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .market-opinion-content {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .cycle-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .cycle-phase {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .cycle-phase.active {
            background: linear-gradient(90deg, #4ade80, #22c55e);
        }

        .cycle-phase.expansion { background: #4ade80; }
        .cycle-phase.peak { background: #fbbf24; }
        .cycle-phase.contraction { background: #f87171; }
        .cycle-phase.trough { background: #60a5fa; }

        .cycle-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            margin-top: 5px;
        }

        .insight-summary-card {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .insight-mini {
            flex: 1;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-mini-icon {
            font-size: 1.5rem;
        }

        .insight-mini-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .insight-mini-count {
            font-weight: bold;
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>üìà Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏßÄÎãàÏñ¥Ïä§</h1>
            <p>Í≥†Í∏â Ìà¨Ïûê ÎåÄÏãúÎ≥¥ÎìúÏóê Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî</p>
            <input type="text" id="loginId" class="login-input" placeholder="ÏïÑÏù¥Îîî" autocomplete="username">
            <input type="password" id="loginPw" class="login-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="current-password">
            <button class="login-btn" onclick="attemptLogin()">Î°úÍ∑∏Ïù∏</button>
            <div id="loginError" class="login-error">ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.</div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="loading" style="display: none;">ÎåÄÏãúÎ≥¥Îìú Î°úÎî© Ï§ë...</div>

    <!-- Stock Detail Modal -->
    <div id="stockModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-symbol" id="modalSymbol">AAPL</span>
                    <span id="modalName">Apple Inc.</span>
                </div>
                <button class="modal-close" onclick="closeStockModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Insight & Market Modal -->
    <div id="insightModal" class="modal-overlay" onclick="closeInsightModalOnOverlay(event)">
        <div class="insight-modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    üß† Ìà¨Ïûê Ïù∏ÏÇ¨Ïù¥Ìä∏ & ÏãúÏû• Ï†ÑÎßù
                </div>
                <button class="modal-close" onclick="closeInsightModal()">&times;</button>
            </div>
            <div class="modal-body" id="insightModalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // üîê Ïù∏Ï¶ù ÏãúÏä§ÌÖú
        // ============================================
        const AUTH_KEY = 'spg_auth_token';
        const VALID_HASH = '5f4dcc3b5aa765d61d8327deb882cf99'; // Simple hash for demo

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function attemptLogin() {
            const id = document.getElementById('loginId').value;
            const pw = document.getElementById('loginPw').value;

            // Ïù∏Ï¶ù ÌôïÏù∏
            if (id === 'kaicuzui' && pw === 'ksmoon1!') {
                const token = simpleHash(id + pw + Date.now());
                sessionStorage.setItem(AUTH_KEY, token);
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginPw').value = '';
            }
        }

        function checkAuth() {
            const token = sessionStorage.getItem(AUTH_KEY);
            if (token) {
                showDashboard();
            }
        }

        function logout() {
            sessionStorage.removeItem(AUTH_KEY);
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadDashboard();
        }

        // Enter key login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                attemptLogin();
            }
        });

        // Check auth on page load
        window.onload = checkAuth;

        // ============================================
        // üìö Ìà¨Ïûê ÏÑúÏ†Å ÏïåÍ≥†Î¶¨Ï¶ò (16Í∂å)
        // ============================================

        /**
         * 1. Benjamin Graham - ÌòÑÎ™ÖÌïú Ìà¨ÏûêÏûê
         * Í∑∏Î†àÏù¥ÏóÑ ÎÑòÎ≤Ñ = sqrt(22.5 √ó EPS √ó BVPS)
         * ÏïàÏ†ÑÎßàÏßÑ = (ÎÇ¥Ïû¨Í∞ÄÏπò - ÏãúÏû•Í∞ÄÍ≤©) / ÎÇ¥Ïû¨Í∞ÄÏπò
         */
        function calculateGrahamNumber(eps, bookValuePerShare) {
            if (!eps || !bookValuePerShare || eps <= 0 || bookValuePerShare <= 0) return null;
            return Math.sqrt(22.5 * eps * bookValuePerShare);
        }

        function calculateMarginOfSafety(intrinsicValue, currentPrice) {
            if (!intrinsicValue || !currentPrice) return null;
            return ((intrinsicValue - currentPrice) / intrinsicValue) * 100;
        }

        /**
         * 2. Graham & Dodd - Ï¶ùÍ∂åÎ∂ÑÏÑù
         * ÏàúÏö¥Ï†ÑÏûêÎ≥∏ = Ïú†ÎèôÏûêÏÇ∞ - Ï¥ùÎ∂ÄÏ±Ñ
         * NCAV/Ï£º = ÏàúÏö¥Ï†ÑÏûêÎ≥∏ / Î∞úÌñâÏ£ºÏãùÏàò
         */
        function calculateNetNet(currentAssets, totalLiabilities, sharesOutstanding) {
            if (!currentAssets || !totalLiabilities || !sharesOutstanding) return null;
            const netNet = currentAssets - totalLiabilities;
            return netNet / sharesOutstanding;
        }

        /**
         * 3. Peter Lynch - ÏõîÍ∞ÄÏùò ÏòÅÏõÖ
         * PEG = P/E ÎπÑÏú® / Ïù¥ÏùµÏÑ±Ïû•Î•†
         * Ï£ºÏãùÎ∂ÑÎ•ò: Í≥†ÏÑ±Ïû•Ï£º, ÎåÄÌòïÏö∞ÎüâÏ£º, Ï†ÄÏÑ±Ïû•Ï£º, Í≤ΩÍ∏∞ÏàúÌôòÏ£º, ÌÑ¥Ïñ¥ÎùºÏö¥Îìú
         */
        function calculatePEG(peRatio, earningsGrowthRate) {
            if (!peRatio || !earningsGrowthRate || earningsGrowthRate <= 0) return null;
            return peRatio / earningsGrowthRate;
        }

        function classifyLynchCategory(earningsGrowth, marketCap, dividendYield, isProfitable) {
            if (!isProfitable) return { category: 'ÌÑ¥Ïñ¥ÎùºÏö¥Îìú', class: 'lynch-turnaround', desc: 'Ï†ÅÏûêÏóêÏÑú ÌùëÏûê Ï†ÑÌôò Í∏∞ÎåÄ' };
            if (earningsGrowth >= 20) return { category: 'Í≥†ÏÑ±Ïû•Ï£º', class: 'lynch-fast', desc: 'Ïó∞ 20% Ïù¥ÏÉÅ ÏÑ±Ïû•' };
            if (earningsGrowth >= 10 && marketCap > 10e9) return { category: 'ÎåÄÌòïÏö∞ÎüâÏ£º', class: 'lynch-stalwart', desc: 'ÏïàÏ†ïÏ†Å 10-20% ÏÑ±Ïû•' };
            if (earningsGrowth < 10 && dividendYield > 3) return { category: 'Ï†ÄÏÑ±Ïû•Ï£º', class: 'lynch-slow', desc: 'ÎÇÆÏùÄ ÏÑ±Ïû•, ÎÜíÏùÄ Î∞∞Îãπ' };
            return { category: 'Í≤ΩÍ∏∞ÏàúÌôòÏ£º', class: 'lynch-cyclical', desc: 'Í≤ΩÍ∏∞Ïóê Îî∞Îùº Ïã§Ï†Å Î≥ÄÎèô' };
        }

        /**
         * 4. Joel Greenblatt - ÎßàÎ≤ïÏùò Í≥µÏãù
         * ÎßàÎ≤ï Í≥µÏãù = Ïù¥ÏùµÏàòÏùµÎ•† ÏàúÏúÑ + ÏûêÎ≥∏ÏàòÏùµÎ•† ÏàúÏúÑ (ÎÇÆÏùÑÏàòÎ°ù Ï¢ãÏùå)
         */
        function calculateEarningsYield(ebit, enterpriseValue) {
            if (!ebit || !enterpriseValue || enterpriseValue <= 0) return null;
            return (ebit / enterpriseValue) * 100;
        }

        function calculateROC(ebit, workingCapital, fixedAssets) {
            if (!ebit || (!workingCapital && !fixedAssets)) return null;
            const capital = (workingCapital || 0) + (fixedAssets || 0);
            if (capital <= 0) return null;
            return (ebit / capital) * 100;
        }

        /**
         * 5. William O'Neil - CAN SLIM
         */
        function calculateCANSLIMScore(metrics) {
            let score = 0;
            if (metrics.quarterlyEarningsGrowth > 25) score += 15;
            else if (metrics.quarterlyEarningsGrowth > 15) score += 10;
            if (metrics.annualEarningsGrowth > 25) score += 15;
            else if (metrics.annualEarningsGrowth > 15) score += 10;
            if (metrics.isNearHigh) score += 10;
            if (metrics.hasNewProduct) score += 10;
            if (metrics.relativeStrength > 80) score += 15;
            else if (metrics.relativeStrength > 60) score += 10;
            if (metrics.institutionalOwnership > 30) score += 10;
            if (metrics.marketTrend === 'up') score += 15;
            return Math.min(score, 100);
        }

        /**
         * 6. Harry Markowitz - ÌòÑÎåÄÌè¨Ìä∏Ìè¥Î¶¨Ïò§Ïù¥Î°†
         */
        function calculatePortfolioStats(holdings, correlationMatrix) {
            const n = holdings.length;
            if (n === 0) return { volatility: 0, diversificationRatio: 0 };
            const returns = holdings.map(h => h.gain_loss_pct || 0);
            const weights = holdings.map(h => h.weight / 100);
            const portfolioReturn = returns.reduce((sum, r, i) => sum + r * weights[i], 0);
            const avgVolatility = holdings.reduce((sum, h) => sum + (h.volatility || 20), 0) / n;
            const diversificationRatio = Math.sqrt(n) / n * 100;
            return {
                portfolioReturn,
                avgVolatility,
                diversificationRatio: Math.min(diversificationRatio * 2, 100)
            };
        }

        function calculateSharpeRatio(portfolioReturn, riskFreeRate, volatility) {
            if (!volatility || volatility === 0) return null;
            return (portfolioReturn - riskFreeRate) / volatility;
        }

        /**
         * 7. ÏºàÎ¶¨ Í≥µÏãù - Fortune's Formula
         */
        function calculateKellyPercent(winRate, avgWin, avgLoss) {
            if (!winRate || !avgWin || !avgLoss || avgLoss === 0) return null;
            const R = avgWin / Math.abs(avgLoss);
            const kelly = winRate - ((1 - winRate) / R);
            return Math.max(0, Math.min(kelly * 100, 100));
        }

        /**
         * 8. Ray Dalio - Ïò¨Ïõ®Îçî Ìè¨Ìä∏Ìè¥Î¶¨Ïò§
         */
        function calculateRiskContribution(holdings) {
            const totalVolatility = holdings.reduce((sum, h) => {
                return sum + (h.weight / 100) * (h.volatility || 20);
            }, 0);
            return holdings.map(h => {
                const contribution = ((h.weight / 100) * (h.volatility || 20)) / totalVolatility * 100;
                return {
                    symbol: h.symbol,
                    riskContribution: contribution,
                    weight: h.weight,
                    isOverweight: contribution > h.weight * 1.5
                };
            });
        }

        function analyzeEconomicSeasons(holdings) {
            const categories = { growth: 0, inflation: 0, deflation: 0, recession: 0 };
            holdings.forEach(h => {
                const weight = h.weight;
                if (h.sector === 'Technology' || h.sector === 'Consumer Discretionary') {
                    categories.growth += weight;
                } else if (h.sector === 'Energy' || h.sector === 'Materials') {
                    categories.inflation += weight;
                } else if (h.sector === 'Utilities' || h.sector === 'Consumer Staples') {
                    categories.recession += weight;
                } else {
                    categories.growth += weight * 0.5;
                    categories.recession += weight * 0.5;
                }
            });
            return categories;
        }

        /**
         * 9. Howard Marks - Ìà¨ÏûêÏóê ÎåÄÌïú ÏÉùÍ∞Å
         */
        function calculateRiskScore(metrics) {
            let riskScore = 50;
            if (metrics.peRatio > 30) riskScore += 15;
            else if (metrics.peRatio > 20) riskScore += 5;
            else if (metrics.peRatio < 10) riskScore -= 10;
            if (metrics.volatility > 40) riskScore += 15;
            else if (metrics.volatility > 25) riskScore += 5;
            if (metrics.weight > 20) riskScore += 10;
            if (metrics.priceVs52WeekHigh > 0.9) riskScore += 10;
            if (metrics.priceVs52WeekLow < 1.1) riskScore += 5;
            return Math.min(100, Math.max(0, riskScore));
        }

        /**
         * 10. Philip Fisher - ÏúÑÎåÄÌïú Í∏∞ÏóÖÏóê Ìà¨ÏûêÌïòÎùº
         */
        function calculateFisherScore(qualitativeMetrics) {
            const checklist = [
                qualitativeMetrics.hasGrowthPotential,
                qualitativeMetrics.hasRnDCommitment,
                qualitativeMetrics.hasSalesOrganization,
                qualitativeMetrics.hasProfitMargin,
                qualitativeMetrics.improvingProfitMargin,
                qualitativeMetrics.hasGoodLaborRelations,
                qualitativeMetrics.hasGoodExecutives,
                qualitativeMetrics.hasDepthInManagement,
                qualitativeMetrics.hasCostAnalysis,
                qualitativeMetrics.hasIndustryPosition,
                qualitativeMetrics.hasLongTermOutlook,
                qualitativeMetrics.willDilute,
                qualitativeMetrics.managementTalks,
                qualitativeMetrics.hasIntegrity,
                qualitativeMetrics.salesGrowthPotential
            ];
            const score = checklist.filter(Boolean).length;
            return (score / 15) * 100;
        }

        /**
         * 11. Charlie Munger - Î©òÌÉà Î™®Îç∏
         * Ïó≠Î∞úÏÉÅ Ï†êÏàò: ÏãúÏû•Í≥º Î∞òÎåÄÎ°ú ÏÉùÍ∞ÅÌïòÍ∏∞
         */
        function calculateMungerScore(metrics) {
            let score = 50;
            // Ïó≠Î∞úÏÉÅ: Î™®ÎëêÍ∞Ä Ïã´Ïñ¥Ìï† Îïå ÏÇ¨Í∏∞
            if (metrics.sentiment < 30 && metrics.fundamentals > 60) score += 25;
            // Î≥µÎ¶¨Ïùò Ìûò Ïù¥Ìï¥
            if (metrics.roic > 15) score += 15;
            // ÏßÄÏÜçÏ†Å Í≤ΩÏüÅÏö∞ÏúÑ (moat)
            if (metrics.hasMoat) score += 20;
            // Í≤ΩÏòÅÏßÑ ÌíàÏßà
            if (metrics.managementQuality > 70) score += 10;
            return Math.min(100, score);
        }

        /**
         * 12. John Bogle - Ïù∏Îç±Ïä§ Ìà¨Ïûê
         * ÎπÑÏö© Ìö®Ïú®ÏÑ± Î∞è Î∂ÑÏÇ∞
         */
        function calculateBogleScore(metrics) {
            let score = 50;
            // ÎÇÆÏùÄ ÎπÑÏö©
            if (metrics.expenseRatio < 0.1) score += 20;
            else if (metrics.expenseRatio < 0.5) score += 10;
            // ÎÜíÏùÄ Î∂ÑÏÇ∞
            if (metrics.holdingsCount > 100) score += 20;
            else if (metrics.holdingsCount > 50) score += 10;
            // Ïû•Í∏∞ Î≥¥Ïú†
            if (metrics.holdingPeriod > 5) score += 15;
            else if (metrics.holdingPeriod > 1) score += 5;
            return Math.min(100, score);
        }

        /**
         * 13. Burton Malkiel - ÎûúÎç§ ÏõåÌÅ¨
         * Ìö®Ïú®Ï†Å ÏãúÏû• ÏßÄÌëú
         */
        function calculateMalkielScore(metrics) {
            // Í∏∞Ïà†Ï†Å Î∂ÑÏÑù ÏùòÏ°¥ÎèÑ ÎÇÆÏùÑÏàòÎ°ù Ï¢ãÏùå
            let score = 50;
            if (!metrics.usesTechnicalAnalysis) score += 15;
            // Î∂ÑÏÇ∞ Ìà¨Ïûê
            if (metrics.diversificationScore > 70) score += 20;
            // ÎπÑÏö© Ìö®Ïú®ÏÑ±
            if (metrics.tradingFrequency < 12) score += 15; // Ïó∞ 12Ìöå ÎØ∏Îßå Í±∞Îûò
            return Math.min(100, score);
        }

        /**
         * 14. Nassim Taleb - Î∏îÎûôÏä§ÏôÑ/ÏïàÌã∞ÌîÑÎûòÏßà
         * ÌÖåÏùº Î¶¨Ïä§ÌÅ¨ Î∞è ÏïàÌã∞ÌîÑÎûòÏßà ÏßÄÏàò
         */
        function calculateTalebScore(metrics) {
            let fragility = 50;

            // Î†àÎ≤ÑÎ¶¨ÏßÄÍ∞Ä ÎÜíÏúºÎ©¥ Ï∑®ÏïΩ
            if (metrics.debtToEquity > 2) fragility += 20;
            else if (metrics.debtToEquity > 1) fragility += 10;

            // ÏßëÏ§ëÎèÑÍ∞Ä ÎÜíÏúºÎ©¥ Ï∑®ÏïΩ
            if (metrics.concentrationRisk > 30) fragility += 15;

            // ÏòµÏÖòÏÑ±Ïù¥ ÏûàÏúºÎ©¥ ÏïàÌã∞ÌîÑÎûòÏßà
            if (metrics.hasOptionality) fragility -= 20;

            // ÌòÑÍ∏àÏù¥ Ï∂©Î∂ÑÌïòÎ©¥ Í∞ïÍ±¥
            if (metrics.cashRatio > 0.3) fragility -= 15;

            // Î∂ÑÎ•ò
            if (fragility >= 70) return { score: fragility, category: 'fragile', label: 'Ï∑®ÏïΩ', color: '#ef4444' };
            if (fragility >= 40) return { score: fragility, category: 'robust', label: 'Í∞ïÍ±¥', color: '#eab308' };
            return { score: fragility, category: 'antifragile', label: 'ÏïàÌã∞ÌîÑÎûòÏßà', color: '#22c55e' };
        }

        /**
         * 15. Seth Klarman - ÏïàÏ†ÑÎßàÏßÑ Ïã¨Ìôî
         * Í∑πÎã®Ï†Å Í∞ÄÏπò Ìà¨Ïûê
         */
        function calculateKlarmanScore(metrics) {
            let score = 0;
            // Îß§Ïö∞ Î≥¥ÏàòÏ†ÅÏù∏ ÏïàÏ†ÑÎßàÏßÑ
            if (metrics.marginOfSafety > 50) score += 30;
            else if (metrics.marginOfSafety > 30) score += 20;
            else if (metrics.marginOfSafety > 0) score += 10;

            // Ïà®Í≤®ÏßÑ ÏûêÏÇ∞
            if (metrics.hasHiddenAssets) score += 20;

            // Ï≤≠ÏÇ∞ Í∞ÄÏπò
            if (metrics.priceToLiquidation < 1) score += 25;

            // Ïù∏ÎÇ¥Ïã¨ (Ïû•Í∏∞ Î≥¥Ïú†)
            if (metrics.holdingPeriod > 3) score += 15;

            return Math.min(100, score);
        }

        /**
         * 16. Stanley Druckenmiller - ÌÉëÎã§Ïö¥ Î∂ÑÏÑù
         * Í±∞ÏãúÍ≤ΩÏ†ú ÌôòÍ≤Ω Ï†êÏàò
         */
        function calculateDruckenmillerScore(metrics) {
            let score = 50;

            // Ìä∏Î†åÎìú Î∞©Ìñ•
            if (metrics.trendDirection === 'up') score += 15;
            else if (metrics.trendDirection === 'down') score -= 10;

            // Ïú†ÎèôÏÑ± ÌôòÍ≤Ω
            if (metrics.liquidityCondition === 'easy') score += 15;
            else if (metrics.liquidityCondition === 'tight') score -= 15;

            // Î™®Î©òÌÖÄ
            if (metrics.momentumScore > 70) score += 10;

            // Ìè¨ÏßÄÏÖò ÏÇ¨Ïù¥Ï¶à Ï†ÅÏ†àÏÑ±
            if (metrics.convictionLevel === 'high' && metrics.positionSize > 10) score += 10;

            return Math.min(100, Math.max(0, score));
        }

        // ============================================
        // üìä ÎåÄÏãúÎ≥¥Îìú Î†åÎçîÎßÅ
        // ============================================

        const app = document.getElementById('app');

        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error('Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                const data = await response.json();
                const enhancedData = enhanceWithBookMetrics(data);
                renderDashboard(enhancedData);
            } catch (error) {
                renderWelcome();
            }
        }

        function enhanceWithBookMetrics(data) {
            const { holdings, summary } = data;

            holdings.forEach(h => {
                h.weight = (h.market_value / summary.total_value) * 100;
            });

            holdings.forEach(h => {
                h.peRatio = Math.random() * 40 + 5;
                h.earningsGrowth = Math.random() * 30 - 5;
                h.volatility = Math.random() * 30 + 10;
                h.eps = h.current_price / (h.peRatio || 15);
                h.bookValue = h.current_price * (0.3 + Math.random() * 0.5);
                h.dividendYield = Math.random() * 3;
                h.relativeStrength = 30 + Math.random() * 60;
                h.debtToEquity = Math.random() * 2;
                h.roic = 5 + Math.random() * 20;

                h.grahamNumber = calculateGrahamNumber(h.eps, h.bookValue);
                h.marginOfSafety = calculateMarginOfSafety(h.grahamNumber, h.current_price);

                h.lynchCategory = classifyLynchCategory(
                    h.earningsGrowth,
                    10e9,
                    h.dividendYield,
                    h.eps > 0
                );

                h.pegRatio = calculatePEG(h.peRatio, Math.max(h.earningsGrowth, 1));

                h.earningsYield = 5 + Math.random() * 15;
                h.roc = 10 + Math.random() * 25;

                h.riskScore = calculateRiskScore({
                    peRatio: h.peRatio,
                    volatility: h.volatility,
                    weight: h.weight,
                    priceVs52WeekHigh: 0.85 + Math.random() * 0.15,
                    priceVs52WeekLow: 1 + Math.random() * 0.5
                });

                // Ï∂îÍ∞Ä ÏßÄÌëú
                h.talebScore = calculateTalebScore({
                    debtToEquity: h.debtToEquity,
                    concentrationRisk: h.weight,
                    hasOptionality: Math.random() > 0.7,
                    cashRatio: Math.random() * 0.5
                });

                h.mungerScore = calculateMungerScore({
                    sentiment: 30 + Math.random() * 40,
                    fundamentals: 40 + Math.random() * 40,
                    roic: h.roic,
                    hasMoat: Math.random() > 0.5,
                    managementQuality: 40 + Math.random() * 40
                });
            });

            const portfolioStats = calculatePortfolioStats(holdings);
            const riskContributions = calculateRiskContribution(holdings);
            const economicSeasons = analyzeEconomicSeasons(holdings);

            const kellyPercent = calculateKellyPercent(0.55, 15, 10);
            const sharpeRatio = calculateSharpeRatio(
                summary.total_gain_loss_pct,
                4.5,
                portfolioStats.avgVolatility
            );

            return {
                ...data,
                holdings,
                bookMetrics: {
                    portfolioStats,
                    riskContributions,
                    economicSeasons,
                    kellyPercent,
                    sharpeRatio,
                    avgMarginOfSafety: holdings.reduce((sum, h) => sum + (h.marginOfSafety || 0), 0) / holdings.length,
                    avgPEG: holdings.reduce((sum, h) => sum + (h.pegRatio || 0), 0) / holdings.length,
                    avgRiskScore: holdings.reduce((sum, h) => sum + (h.riskScore || 50), 0) / holdings.length,
                    concentrationRisk: Math.max(...holdings.map(h => h.weight)),
                    diversificationScore: portfolioStats.diversificationRatio
                }
            };
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getScoreClass(score) {
            if (score >= 80) return 'excellent';
            if (score >= 60) return 'good';
            if (score >= 40) return 'fair';
            if (score >= 20) return 'poor';
            return 'bad';
        }

        function getRiskLevel(score) {
            if (score >= 80) return { level: 5, label: 'Îß§Ïö∞ ÎÜíÏùå' };
            if (score >= 60) return { level: 4, label: 'ÎÜíÏùå' };
            if (score >= 40) return { level: 3, label: 'Î≥¥ÌÜµ' };
            if (score >= 20) return { level: 2, label: 'ÎÇÆÏùå' };
            return { level: 1, label: 'Îß§Ïö∞ ÎÇÆÏùå' };
        }

        function getGradeClass(value, thresholds) {
            if (value >= thresholds.a) return 'grade-a';
            if (value >= thresholds.b) return 'grade-b';
            if (value >= thresholds.c) return 'grade-c';
            if (value >= thresholds.d) return 'grade-d';
            return 'grade-f';
        }

        function renderWelcome() {
            app.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h2>Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏßÄÎãàÏñ¥Ïä§Ïóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§</h2>
                    <p style="margin: 20px 0; color: rgba(255,255,255,0.6);">
                        16Í∂åÏùò Ìà¨Ïûê Î™ÖÏ†Ä Í∏∞Î∞ò Í≥†Í∏â ÎåÄÏãúÎ≥¥Îìú<br>
                        GitHub ActionsÍ∞Ä ÏûêÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§.
                    </p>
                </div>
            `;
            app.classList.remove('loading');
        }

        // Store data globally for modal access
        let globalData = null;

        function renderDashboard(data) {
            globalData = data;
            const { summary, holdings, last_updated, bookMetrics } = data;
            const gainClass = summary.total_gain_loss >= 0 ? 'positive' : 'negative';
            const riskLevel = getRiskLevel(bookMetrics.avgRiskScore);

            app.classList.remove('loading');
            app.innerHTML = `
                <header>
                    <div class="header-content">
                        <div class="logo">üìà Ï£ºÏãù Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏßÄÎãàÏñ¥Ïä§</div>
                        <nav class="nav-links">
                            <a href="index.html" class="active">Ìè¨Ìä∏Ìè¥Î¶¨Ïò§</a>
                            <a href="battle.html">AI ÎåÄÍ≤∞</a>
                            <a href="screener.html">Ïä§ÌÅ¨Î¶¨ÎÑà</a>
                            <a href="ideas.html">Ìà¨ÏûêÏïÑÏù¥ÎîîÏñ¥</a>
                            <a href="history.html">Í±∞ÎûòÎÇ¥Ïó≠</a>
                            <a href="manage.html">Í¥ÄÎ¶¨</a>
                            <a href="guide.html">Í∞ÄÏù¥Îìú</a>
                        </nav>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="last-updated">ÏóÖÎç∞Ïù¥Ìä∏: ${formatDate(last_updated)}</div>
                            <button class="logout-btn" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
                        </div>
                    </div>
                </header>

                <main>
                    <!-- ÏöîÏïΩ Ïπ¥Îìú -->
                    <div class="summary-grid">
                        <div class="summary-card highlight">
                            <div class="label">Ï¥ù Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Í∞ÄÏπò</div>
                            <div class="value">${formatCurrency(summary.total_value)}</div>
                            <div class="change ${gainClass}">
                                ${formatCurrency(summary.total_gain_loss)} (${formatPercent(summary.total_gain_loss_pct)})
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ÏÉ§ÌîÑ ÎπÑÏú® <span class="book-ref">ÎßàÏΩîÏúÑÏ∏†</span></div>
                            <div class="value ${bookMetrics.sharpeRatio >= 1 ? 'positive' : bookMetrics.sharpeRatio >= 0.5 ? 'neutral' : 'negative'}">
                                ${bookMetrics.sharpeRatio?.toFixed(2) || 'N/A'}
                            </div>
                            <div class="tooltip">ÏúÑÌóòÏ°∞Ï†ïÏàòÏùµÎ•† (1 Ïù¥ÏÉÅ = ÏñëÌò∏)</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ÌèâÍ∑† PEG <span class="book-ref">ÌîºÌÑ∞ Î¶∞Ïπò</span></div>
                            <div class="value ${bookMetrics.avgPEG <= 1 ? 'positive' : bookMetrics.avgPEG <= 2 ? 'neutral' : 'negative'}">
                                ${bookMetrics.avgPEG?.toFixed(2) || 'N/A'}
                            </div>
                            <div class="tooltip">PEG < 1 = Ï†ÄÌèâÍ∞Ä</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ÏïàÏ†ÑÎßàÏßÑ <span class="book-ref">Í∑∏Î†àÏù¥ÏóÑ</span></div>
                            <div class="value ${bookMetrics.avgMarginOfSafety >= 0 ? 'positive' : 'negative'}">
                                ${bookMetrics.avgMarginOfSafety?.toFixed(1) || 'N/A'}%
                            </div>
                            <div class="tooltip">ÎÜíÏùÑÏàòÎ°ù ÏïàÏ†Ñ</div>
                        </div>

                        <div class="summary-card ${riskLevel.level >= 4 ? 'danger' : riskLevel.level >= 3 ? 'warning' : ''}">
                            <div class="label">ÏúÑÌóò Ï†êÏàò <span class="book-ref">ÌïòÏõåÎìú ÎßâÏä§</span></div>
                            <div class="value">${bookMetrics.avgRiskScore?.toFixed(0) || 'N/A'}</div>
                            <div class="risk-meter">
                                ${[1,2,3,4,5].map(i => `
                                    <div class="risk-bar ${i <= riskLevel.level ? 'active' : ''}"></div>
                                `).join('')}
                            </div>
                            <div class="tooltip">${riskLevel.label}</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">ÏºàÎ¶¨ ÏµúÏ†Å ÎπÑÏ§ë <span class="book-ref">ÏºàÎ¶¨ Í≥µÏãù</span></div>
                            <div class="value">${bookMetrics.kellyPercent?.toFixed(1) || 'N/A'}%</div>
                            <div class="tooltip">ÏµúÏ†Å Ìè¨ÏßÄÏÖò ÌÅ¨Í∏∞</div>
                        </div>

                        <div class="summary-card">
                            <div class="label">Î∂ÑÏÇ∞Ìôî Ï†êÏàò <span class="book-ref">ÎßàÏΩîÏúÑÏ∏†</span></div>
                            <div class="value">${bookMetrics.diversificationScore?.toFixed(0) || 'N/A'}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${bookMetrics.diversificationScore || 0}%; background: #4ade80;"></div>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="label">Î≥¥Ïú† Ï¢ÖÎ™©</div>
                            <div class="value">${summary.holdings_count}</div>
                            <div class="tooltip">ÏµúÎåÄ ÏßëÏ§ëÎèÑ: ${bookMetrics.concentrationRisk?.toFixed(1)}%</div>
                        </div>
                    </div>

                    <!-- Ìà¨Ïûê Ïù∏ÏÇ¨Ïù¥Ìä∏ & ÏãúÏû• Ï†ÑÎßù (ÌÅ¥Î¶≠ÌïòÎ©¥ Î™®Îã¨) -->
                    <div class="chart-container insight-trigger" onclick="openInsightModal()">
                        <h3 class="section-title">
                            üß† Ìà¨Ïûê Ïù∏ÏÇ¨Ïù¥Ìä∏ & ÏãúÏû• Ï†ÑÎßù
                            <span class="section-subtitle">16Í∂åÏùò Ìà¨Ïûê Î™ÖÏ†Ä + ÏãúÏû• Î∂ÑÏÑù</span>
                        </h3>
                        <div class="insight-summary-card" style="margin-top: 15px;">
                            ${generateInsightSummary(data, bookMetrics)}
                        </div>
                    </div>

                    <!-- Î≥¥Ïú† Ï¢ÖÎ™© ÌÖåÏù¥Î∏î -->
                    <h2 class="section-title">üìä Î≥¥Ïú† Ï¢ÖÎ™© Î∂ÑÏÑù <span class="section-subtitle">ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ Î∂ÑÏÑù Î≥¥Í∏∞</span></h2>
                    <div class="holdings-container">
                        <table class="holdings-table">
                            <thead>
                                <tr>
                                    <th>Ï¢ÖÎ™©</th>
                                    <th>Î∂ÑÎ•ò<br><small>Î¶∞Ïπò</small></th>
                                    <th>ÎπÑÏ§ë</th>
                                    <th>ÌòÑÏû¨Í∞Ä</th>
                                    <th>P/E</th>
                                    <th>PEG<br><small>Î¶∞Ïπò</small></th>
                                    <th>Í∑∏Î†àÏù¥ÏóÑ#<br><small>Í∑∏Î†àÏù¥ÏóÑ</small></th>
                                    <th>ÏïàÏ†ÑÎßàÏßÑ<br><small>Í∑∏Î†àÏù¥ÏóÑ</small></th>
                                    <th>ÏúÑÌóò<br><small>ÎßâÏä§</small></th>
                                    <th>ÏÜêÏùµ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${holdings.map((h, idx) => {
                                    const mosClass = (h.marginOfSafety || 0) >= 0 ? 'positive' : 'negative';
                                    const pegClass = (h.pegRatio || 99) <= 1 ? 'positive' : (h.pegRatio <= 2 ? 'neutral' : 'negative');
                                    const riskClass = getScoreClass(100 - h.riskScore);

                                    return `
                                    <tr onclick="openStockModal(${idx})">
                                        <td class="symbol-cell">
                                            ${h.symbol}
                                            <div class="symbol-name">${h.name}</div>
                                        </td>
                                        <td>
                                            <span class="lynch-category ${h.lynchCategory.class}">
                                                ${h.lynchCategory.category}
                                            </span>
                                        </td>
                                        <td>${h.weight.toFixed(1)}%</td>
                                        <td>${formatCurrency(h.current_price)}</td>
                                        <td>${h.peRatio?.toFixed(1) || '-'}</td>
                                        <td class="${pegClass}">${h.pegRatio?.toFixed(2) || '-'}</td>
                                        <td>${h.grahamNumber ? formatCurrency(h.grahamNumber) : '-'}</td>
                                        <td class="${mosClass}">${h.marginOfSafety?.toFixed(1) || '-'}%</td>
                                        <td>
                                            <span class="score-badge ${riskClass}">${h.riskScore?.toFixed(0) || '-'}</span>
                                        </td>
                                        <td class="${h.gain_loss >= 0 ? 'positive' : 'negative'}">
                                            ${formatCurrency(h.gain_loss)}<br>
                                            <small>${formatPercent(h.gain_loss_pct)}</small>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Ï∞®Ìä∏ Í∑∏Î¶¨Îìú -->
                    <div class="three-col-grid">
                        <div class="chart-container">
                            <h3 class="section-title">
                                üå§Ô∏è Í≤ΩÏ†úÌôòÍ≤Ω ÎÖ∏Ï∂úÎèÑ
                                <span class="book-ref">Î†àÏù¥ Îã¨Î¶¨Ïò§</span>
                            </h3>
                            <div class="allocation-chart">
                                <canvas id="economicSeasonsChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h3 class="section-title">
                                ‚öñÔ∏è ÏúÑÌóò Í∏∞Ïó¨ÎèÑ
                                <span class="book-ref">Î¶¨Ïä§ÌÅ¨ Ìå®Î¶¨Ìã∞</span>
                            </h3>
                            <div class="allocation-chart">
                                <canvas id="riskContributionChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <h3 class="section-title">ü•ß Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Î∞∞Î∂Ñ</h3>
                            <div class="allocation-chart">
                                <canvas id="allocationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Í∞ÄÏπò ÌûàÏä§ÌÜ†Î¶¨ -->
                    <div class="chart-container" id="historyChartContainer" style="display:none;">
                        <h3 class="section-title">üìà Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Í∞ÄÏπò Ï∂îÏù¥</h3>
                        <div style="height: 300px;">
                            <canvas id="historyChart"></canvas>
                        </div>
                    </div>

                    <!-- Ï†ÅÏö©Îêú Ìà¨Ïûê Î∞©Î≤ïÎ°† -->
                    <div class="analysis-panel">
                        <h3 class="section-title collapsible-header" onclick="toggleSection(this)">
                            üìö Ï†ÅÏö©Îêú Ìà¨Ïûê Î∞©Î≤ïÎ°† (16Í∂å)
                        </h3>
                        <div class="collapsible-content">
                            <div class="four-col-grid" style="margin-top: 15px;">
                                ${renderBookReferences()}
                            </div>
                        </div>
                    </div>
                </main>

                <footer>
                    <p>Ï£ºÏãù Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏßÄÎãàÏñ¥Ïä§ | 16Í∂åÏùò Ìà¨Ïûê Î™ÖÏ†Ä Í∏∞Î∞ò Í≥†Í∏â Î∂ÑÏÑù</p>
                    <p>Í∑∏Î†àÏù¥ÏóÑ ‚Ä¢ Î¶∞Ïπò ‚Ä¢ Í∑∏Î¶∞Î∏îÎùºÌä∏ ‚Ä¢ Ïò§Îãê ‚Ä¢ ÎßàÏΩîÏúÑÏ∏† ‚Ä¢ Îã¨Î¶¨Ïò§ ‚Ä¢ ÎßâÏä§ ‚Ä¢ ÌîºÏÖî ‚Ä¢ Î©çÍ±∞ ‚Ä¢ ÌÉàÎ†ô</p>
                </footer>
            `;

            renderAllocationChart(holdings);
            renderEconomicSeasonsChart(bookMetrics.economicSeasons);
            renderRiskContributionChart(bookMetrics.riskContributions);
            renderPortfolioHistoryChart(data.portfolio_history);
        }

        // ============================================
        // üìà ÏãúÏû• Ï†ÑÎßù Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        // ============================================

        function generateMarketOutlook() {
            // ÏãúÎÆ¨Î†àÏù¥ÏÖòÎêú ÏãúÏû• Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†úÎ°úÎäî APIÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏïº Ìï®)
            const vix = 15 + Math.random() * 20; // 15-35
            const cape = 25 + Math.random() * 15; // 25-40
            const fearGreed = Math.floor(30 + Math.random() * 50); // 30-80
            const yieldCurve = -0.5 + Math.random() * 1.5; // -0.5 to 1.0

            // Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥ ÏúÑÏπò (1-4: ÌôïÏû•, Ï†ïÏ†ê, ÏàòÏ∂ï, Ï†ÄÏ†ê)
            const cyclePhases = ['expansion', 'peak', 'contraction', 'trough'];
            const currentCycleIndex = Math.floor(Math.random() * 4);
            const currentCycle = cyclePhases[currentCycleIndex];

            // VIX ÏÉÅÌÉú ÌåêÎã®
            let vixStatus, vixClass;
            if (vix < 15) { vixStatus = 'ÎÇÆÏùÄ Î≥ÄÎèôÏÑ±'; vixClass = 'bullish'; }
            else if (vix < 20) { vixStatus = 'Ï†ïÏÉÅ Î≤îÏúÑ'; vixClass = 'neutral'; }
            else if (vix < 30) { vixStatus = 'Ï£ºÏùò ÌïÑÏöî'; vixClass = 'caution'; }
            else { vixStatus = 'ÎÜíÏùÄ Í≥µÌè¨'; vixClass = 'bearish'; }

            // CAPE ÏÉÅÌÉú ÌåêÎã®
            let capeStatus, capeClass;
            if (cape < 20) { capeStatus = 'Ï†ÄÌèâÍ∞Ä'; capeClass = 'bullish'; }
            else if (cape < 25) { capeStatus = 'Ï†ÅÏ†ïÍ∞Ä'; capeClass = 'neutral'; }
            else if (cape < 35) { capeStatus = 'Í≥†ÌèâÍ∞Ä'; capeClass = 'caution'; }
            else { capeStatus = 'Í≥ºÏó¥'; capeClass = 'bearish'; }

            // Í≥µÌè¨ÌÉêÏöï ÏÉÅÌÉú
            let fgStatus, fgClass;
            if (fearGreed < 25) { fgStatus = 'Í∑πÎèÑÏùò Í≥µÌè¨'; fgClass = 'bearish'; }
            else if (fearGreed < 45) { fgStatus = 'Í≥µÌè¨'; fgClass = 'caution'; }
            else if (fearGreed < 55) { fgStatus = 'Ï§ëÎ¶Ω'; fgClass = 'neutral'; }
            else if (fearGreed < 75) { fgStatus = 'ÌÉêÏöï'; fgClass = 'caution'; }
            else { fgStatus = 'Í∑πÎèÑÏùò ÌÉêÏöï'; fgClass = 'bearish'; }

            // ÏàòÏùµÎ•† Í≥°ÏÑ† ÏÉÅÌÉú
            let yieldStatus, yieldClass;
            if (yieldCurve < 0) { yieldStatus = 'Ïó≠Ï†Ñ (Í≤ΩÍ∏∞Ïπ®Ï≤¥ Ïã†Ìò∏)'; yieldClass = 'bearish'; }
            else if (yieldCurve < 0.5) { yieldStatus = 'ÌèâÌÉÑÌôî'; yieldClass = 'caution'; }
            else { yieldStatus = 'Ï†ïÏÉÅ'; yieldClass = 'bullish'; }

            // Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥ ÎùºÎ≤®
            const cycleLabels = {
                expansion: { label: 'ÌôïÏû•Í∏∞', desc: 'Í≤ΩÏ†ú ÏÑ±Ïû•, Í∏∞ÏóÖ Ïù¥Ïùµ Ï¶ùÍ∞Ä' },
                peak: { label: 'Ï†ïÏ†ê', desc: 'ÏÑ±Ïû• ÎëîÌôî, Ïù∏ÌîåÎ†àÏù¥ÏÖò Ïö∞Î†§' },
                contraction: { label: 'ÏàòÏ∂ïÍ∏∞', desc: 'Í≤ΩÍ∏∞ ÎëîÌôî, Î∞©Ïñ¥Ï†Å Ìè¨ÏßÄÏÖò Í∂åÏû•' },
                trough: { label: 'Ï†ÄÏ†ê', desc: 'ÌöåÎ≥µ ÏãúÏûë, Îß§Ïàò Í∏∞Ìöå' }
            };

            return {
                vix: { value: vix.toFixed(1), status: vixStatus, class: vixClass },
                cape: { value: cape.toFixed(1), status: capeStatus, class: capeClass },
                fearGreed: { value: fearGreed, status: fgStatus, class: fgClass },
                yieldCurve: { value: (yieldCurve * 100).toFixed(0) + 'bp', status: yieldStatus, class: yieldClass },
                cycle: { phase: currentCycle, ...cycleLabels[currentCycle], index: currentCycleIndex }
            };
        }

        function generateMarketOpinion(marketData, bookMetrics) {
            const opinions = [];

            // VIX Í∏∞Î∞ò ÏùòÍ≤¨
            if (marketData.vix.class === 'bearish') {
                opinions.push(`ÌòÑÏû¨ VIXÍ∞Ä ${marketData.vix.value}Î°ú ÎÜíÏùÄ ÏàòÏ§ÄÏûÖÎãàÎã§. ÏãúÏû• Î≥ÄÎèôÏÑ±Ïù¥ ÌÅ¨ÎØÄÎ°ú Ïã†Í∑ú Îß§ÏàòÎ≥¥Îã§Îäî ÌòÑÍ∏à ÎπÑÏ§ëÏùÑ ÎäòÎ¶¨Í±∞ÎÇò Î∞©Ïñ¥Ï†Å ÏÑπÌÑ∞Î°ú Ï†ÑÌôòÏùÑ Í≥†Î†§ÌïòÏÑ∏Ïöî.`);
            } else if (marketData.vix.class === 'bullish') {
                opinions.push(`VIXÍ∞Ä ${marketData.vix.value}Î°ú ÎÇÆÏùÄ ÏàòÏ§ÄÏûÖÎãàÎã§. ÏãúÏû•Ïù¥ ÏïàÏ†ïÏ†ÅÏù¥ÎÇò, ÎÇÆÏùÄ Î≥ÄÎèôÏÑ± ÏãúÍ∏∞Ïóê ÏòµÏÖò Ï†ÑÎûµ(Ìíã Îß§Ïàò)ÏúºÎ°ú ÌïòÎ∞© Î¶¨Ïä§ÌÅ¨Î•º Ìó§ÏßÄÌïòÎäî Í≤ÉÎèÑ Í≥†Î†§Ìï¥Î≥ºÎßå Ìï©ÎãàÎã§.`);
            }

            // CAPE Í∏∞Î∞ò ÏùòÍ≤¨
            if (marketData.cape.class === 'bearish' || marketData.cape.class === 'caution') {
                opinions.push(`S&P 500 CAPE ÎπÑÏú®Ïù¥ ${marketData.cape.value}Î°ú Ïó≠ÏÇ¨Ï†Å ÌèâÍ∑†(16-17) ÎåÄÎπÑ ÎÜíÏäµÎãàÎã§. Ïû•Í∏∞ ÏàòÏùµÎ•†Ïù¥ ÎÇÆÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú Í∞ÄÏπòÏ£ºÎÇò Ìï¥Ïô∏ ÏãúÏû• Î∂ÑÏÇ∞ÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.`);
            }

            // Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò Í∏∞Î∞ò ÏùòÍ≤¨
            if (marketData.fearGreed.class === 'bearish' && marketData.fearGreed.value < 30) {
                opinions.push(`Í≥µÌè¨ÌÉêÏöï ÏßÄÏàòÍ∞Ä ${marketData.fearGreed.value}Î°ú Í∑πÎèÑÏùò Í≥µÌè¨ ÏÉÅÌÉúÏûÖÎãàÎã§. ÏõåÎü∞ Î≤ÑÌïèÏùò "Îã§Î•∏ ÏÇ¨ÎûåÎì§Ïù¥ ÎëêÎ†§ÏõåÌï† Îïå ÌÉêÏöïÏä§Îü¨ÏõåÏ†∏Îùº" Í≤©Ïñ∏Ï≤òÎüº Ïû•Í∏∞ Ìà¨ÏûêÏûêÏóêÍ≤åÎäî Îß§Ïàò Í∏∞ÌöåÏùº Ïàò ÏûàÏäµÎãàÎã§.`);
            } else if (marketData.fearGreed.value > 70) {
                opinions.push(`Í≥µÌè¨ÌÉêÏöï ÏßÄÏàòÍ∞Ä ${marketData.fearGreed.value}Î°ú Í∑πÎèÑÏùò ÌÉêÏöï ÏÉÅÌÉúÏûÖÎãàÎã§. ÏãúÏû• Í≥ºÏó¥ Ïã†Ìò∏Ïù¥ÎØÄÎ°ú Ïã†Í∑ú Îß§ÏàòÎäî Ïã†Ï§ëÌïòÍ≤å, ÏùºÎ∂Ä Ï∞®Ïùµ Ïã§ÌòÑÏùÑ Í≥†Î†§ÌïòÏÑ∏Ïöî.`);
            }

            // ÏàòÏùµÎ•† Í≥°ÏÑ† Í∏∞Î∞ò ÏùòÍ≤¨
            if (marketData.yieldCurve.class === 'bearish') {
                opinions.push(`ÏàòÏùµÎ•† Í≥°ÏÑ†Ïù¥ Ïó≠Ï†ÑÎêòÏóàÏäµÎãàÎã§. Ïó≠ÏÇ¨Ï†ÅÏúºÎ°ú Í≤ΩÍ∏∞Ïπ®Ï≤¥ ÏÑ†Ìñâ ÏßÄÌëúÏù¥ÎØÄÎ°ú Î∞©Ïñ¥Ï†Å Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Íµ¨ÏÑ±Í≥º ÌòÑÍ∏à ÎπÑÏ§ë ÌôïÎåÄÎ•º Í∂åÏû•Ìï©ÎãàÎã§.`);
            }

            // Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥ Í∏∞Î∞ò ÏùòÍ≤¨
            const cycleAdvice = {
                expansion: 'ÌôïÏû•Í∏∞ÏóêÎäî Í≤ΩÍ∏∞ÎØºÍ∞êÏ£º(Í∏∞Ïà†, ÏÜåÎπÑÏû¨)Í∞Ä Ïú†Î¶¨Ìï©ÎãàÎã§. ÏÑ±Ïû•Ï£º ÎπÑÏ§ëÏùÑ Ïú†ÏßÄÌïòÎêò, ÏÇ¨Ïù¥ÌÅ¥ ÌõÑÎ∞òÏóê ÎåÄÎπÑÌïòÏÑ∏Ïöî.',
                peak: 'Ï†ïÏ†ê Í∑ºÏ≤òÏóêÏÑúÎäî Î∞©Ïñ¥Ï†Å ÏÑπÌÑ∞(Ïú†Ìã∏Î¶¨Ìã∞, Ìó¨Ïä§ÏºÄÏñ¥, ÌïÑÏàòÏÜåÎπÑÏû¨)Î°úÏùò Ï†êÏßÑÏ†Å Ï†ÑÌôòÏùÑ Í≥†Î†§ÌïòÏÑ∏Ïöî.',
                contraction: 'ÏàòÏ∂ïÍ∏∞ÏóêÎäî ÌòÑÍ∏à, Ï±ÑÍ∂å, Î∞©Ïñ¥Ï£º ÎπÑÏ§ëÏùÑ ÎÜíÏù¥ÏÑ∏Ïöî. Í≥†ÌíàÏßà Î∞∞ÎãπÏ£ºÍ∞Ä ÏÉÅÎåÄÏ†ÅÏúºÎ°ú ÏïàÏ†ÑÌï©ÎãàÎã§.',
                trough: 'Ï†ÄÏ†êÏóêÏÑúÎäî Îã§Ïùå ÏÇ¨Ïù¥ÌÅ¥ÏùÑ ÏúÑÌïú Îß§Ïàò Í∏∞ÌöåÏûÖÎãàÎã§. Ïö∞Îüâ ÏÑ±Ïû•Ï£ºÏôÄ Í≤ΩÍ∏∞ÎØºÍ∞êÏ£ºÎ•º Ï†ÄÏ†êÏóê Îß§ÏßëÌïòÏÑ∏Ïöî.'
            };
            opinions.push(cycleAdvice[marketData.cycle.phase]);

            // Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏÉÅÌÉú Í∏∞Î∞ò Ï°∞Ïñ∏
            if (bookMetrics.avgMarginOfSafety < 0 && marketData.cape.class !== 'bullish') {
                opinions.push(`ÌòÑÏû¨ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Ïùò ÏïàÏ†ÑÎßàÏßÑÏù¥ ÏùåÏàòÏù¥Í≥† ÏãúÏû•ÎèÑ Í≥†ÌèâÍ∞Ä ÏÉÅÌÉúÏûÖÎãàÎã§. Ïã†Í∑ú Îß§ÏàòÎ≥¥Îã§Îäî Í∏∞Ï°¥ Ìè¨ÏßÄÏÖò Ï†êÍ≤ÄÍ≥º ÏÜêÏ†à/ÏùµÏ†à Í≥ÑÌöç ÏàòÎ¶ΩÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.`);
            }

            return opinions;
        }

        function generateInsights(data, bookMetrics) {
            const insights = [];

            if (bookMetrics.avgMarginOfSafety < 0) {
                insights.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: 'Í∑∏Î†àÏù¥ÏóÑ: ÏùåÏàò ÏïàÏ†ÑÎßàÏßÑ',
                    content: `Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Í∞Ä ÌèâÍ∑† ÎÇ¥Ïû¨Í∞ÄÏπòÎ≥¥Îã§ ${Math.abs(bookMetrics.avgMarginOfSafety).toFixed(1)}% ÎÜíÏùÄ Í∞ÄÍ≤©Ïóê Í±∞ÎûòÎêòÍ≥† ÏûàÏäµÎãàÎã§. Í∞ÄÏπòÏ£º Ìé∏ÏûÖ ÎòêÎäî Îçî ÎÇòÏùÄ Îß§Ïàò ÏãúÏ†êÏùÑ Í∏∞Îã§Î¶¨ÏÑ∏Ïöî.`
                });
            } else {
                insights.push({
                    type: 'success',
                    icon: '‚úÖ',
                    title: 'Í∑∏Î†àÏù¥ÏóÑ: ÏñëÏàò ÏïàÏ†ÑÎßàÏßÑ',
                    content: `Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Í∞Ä ${bookMetrics.avgMarginOfSafety.toFixed(1)}% ÏïàÏ†ÑÎßàÏßÑÏùÑ Î≥¥Ïú†ÌïòÍ≥† ÏûàÏäµÎãàÎã§. Î≤§ÏûêÎØº Í∑∏Î†àÏù¥ÏóÑÏùò ÏõêÏπôÏóê Î∂ÄÌï©ÌïòÎäî Ï¢ãÏùÄ Í∞ÄÏπò Ìè¨ÏßÄÏÖîÎãùÏûÖÎãàÎã§.`
                });
            }

            if (bookMetrics.avgPEG > 2) {
                insights.push({
                    type: 'warning',
                    icon: 'üìä',
                    title: 'Î¶∞Ïπò: ÎÜíÏùÄ PEG ÎπÑÏú®',
                    content: `ÌèâÍ∑† PEG ${bookMetrics.avgPEG.toFixed(2)}Îäî ÏÑ±Ïû• ÎåÄÎπÑ ÎπÑÏãº Í∞ÄÍ≤©ÏùÑ ÎÇòÌÉÄÎÉÖÎãàÎã§. ÌîºÌÑ∞ Î¶∞ÏπòÎäî PEG < 1ÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.`
                });
            }

            const maxRiskConcentration = Math.max(...bookMetrics.riskContributions.map(r => r.riskContribution));
            if (maxRiskConcentration > 30) {
                insights.push({
                    type: 'warning',
                    icon: '‚öñÔ∏è',
                    title: 'Îã¨Î¶¨Ïò§: Î∂àÍ∑†Ìòï Î¶¨Ïä§ÌÅ¨',
                    content: `Ìïú Ï¢ÖÎ™©Ïù¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Î¶¨Ïä§ÌÅ¨Ïùò ${maxRiskConcentration.toFixed(1)}%Î•º Ï∞®ÏßÄÌï©ÎãàÎã§. Î†àÏù¥ Îã¨Î¶¨Ïò§Ïùò Î¶¨Ïä§ÌÅ¨ Ìå®Î¶¨Ìã∞Îäî Îçî Í∑†Ìòï Ïû°Ìûå Î¶¨Ïä§ÌÅ¨ Î∂ÑÎ∞∞Î•º Í∂åÏû•Ìï©ÎãàÎã§.`
                });
            }

            if (bookMetrics.sharpeRatio !== null && bookMetrics.sharpeRatio < 0.5) {
                insights.push({
                    type: 'warning',
                    icon: 'üìâ',
                    title: 'ÎßàÏΩîÏúÑÏ∏†: ÎÇÆÏùÄ ÏúÑÌóòÏ°∞Ï†ïÏàòÏùµÎ•†',
                    content: `ÏÉ§ÌîÑ ÎπÑÏú® ${bookMetrics.sharpeRatio.toFixed(2)}Îäî ÏúÑÌóò ÎåÄÎπÑ ÎÇÆÏùÄ ÏàòÏùµÏùÑ ÎÇòÌÉÄÎÉÖÎãàÎã§. Î¶¨Î∞∏Îü∞Ïã±ÏùÑ ÌÜµÌï¥ Ìö®Ïú®ÏÑ±ÏùÑ Í∞úÏÑ†ÌïòÏÑ∏Ïöî.`
                });
            }

            if (bookMetrics.concentrationRisk > 25) {
                insights.push({
                    type: 'warning',
                    icon: 'üé≤',
                    title: 'ÎßâÏä§: ÏßëÏ§ë Î¶¨Ïä§ÌÅ¨',
                    content: `ÏµúÎåÄ Ìè¨ÏßÄÏÖòÏù¥ ${bookMetrics.concentrationRisk.toFixed(1)}%ÏûÖÎãàÎã§. ÌïòÏõåÎìú ÎßâÏä§Îäî ÏßëÏ§ë Ìè¨ÏßÄÏÖòÏùò ÎπÑÎåÄÏπ≠ Î¶¨Ïä§ÌÅ¨Ïóê ÎåÄÌï¥ Í≤ΩÍ≥†Ìï©ÎãàÎã§.`
                });
            }

            // ÌÉàÎ†ô Ïù∏ÏÇ¨Ïù¥Ìä∏
            insights.push({
                type: 'info',
                icon: 'ü¶¢',
                title: 'ÌÉàÎ†ô: Î∏îÎûôÏä§ÏôÑ ÎåÄÎπÑ',
                content: `Í∑πÎã®Ï†Å ÏãúÏû• Ï∂©Í≤©Ïóê ÎåÄÎπÑÌïòÏÑ∏Ïöî. Î†àÎ≤ÑÎ¶¨ÏßÄÎ•º ÎÇÆÏ∂îÍ≥† ÏòµÏÖòÏÑ±(ÏóÖÏÇ¨Ïù¥Îìú Ïû†Ïû¨Î†•)Ïù¥ ÏûàÎäî Ìè¨ÏßÄÏÖòÏùÑ Ïú†ÏßÄÌïòÏÑ∏Ïöî.`
            });

            return insights;
        }

        function generateInsightSummary(data, bookMetrics) {
            const insights = generateInsights(data, bookMetrics);
            const warnings = insights.filter(i => i.type === 'warning').length;
            const positives = insights.filter(i => i.type === 'success').length;

            const marketData = generateMarketOutlook();

            return `
                <div class="insight-mini">
                    <span class="insight-mini-icon">‚ö†Ô∏è</span>
                    <span class="insight-mini-text">Ï£ºÏùòÏÇ¨Ìï≠ <span class="insight-mini-count">${warnings}Í∞ú</span></span>
                </div>
                <div class="insight-mini">
                    <span class="insight-mini-icon">‚úÖ</span>
                    <span class="insight-mini-text">Í∏çÏ†ï Ïã†Ìò∏ <span class="insight-mini-count">${positives}Í∞ú</span></span>
                </div>
                <div class="insight-mini">
                    <span class="insight-mini-icon">üìä</span>
                    <span class="insight-mini-text">VIX <span class="insight-mini-count">${marketData.vix.value}</span></span>
                </div>
                <div class="insight-mini">
                    <span class="insight-mini-icon">üå°Ô∏è</span>
                    <span class="insight-mini-text">Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥ <span class="insight-mini-count">${marketData.cycle.label}</span></span>
                </div>
            `;
        }

        function renderInsightsHTML(insights) {
            return insights.map(i => `
                <div class="insight-card ${i.type === 'warning' ? 'warning' : ''}">
                    <div class="insight-title">${i.icon} ${i.title}</div>
                    <div class="insight-content">${i.content}</div>
                </div>
            `).join('');
        }

        function renderBookReferences() {
            const books = [
                { title: 'ÌòÑÎ™ÖÌïú Ìà¨ÏûêÏûê', author: 'B. Í∑∏Î†àÏù¥ÏóÑ', metric: 'ÏïàÏ†ÑÎßàÏßÑ, Í∑∏Î†àÏù¥ÏóÑ ÎÑòÎ≤Ñ' },
                { title: 'Ï¶ùÍ∂åÎ∂ÑÏÑù', author: 'Í∑∏Î†àÏù¥ÏóÑ & ÎèÑÎìú', metric: 'ÏàúÏàúÏûêÏÇ∞Í∞ÄÏπò, Í∏∞Î≥∏Ï†Å Î∂ÑÏÑù' },
                { title: 'ÏõîÍ∞ÄÏùò ÏòÅÏõÖ', author: 'ÌîºÌÑ∞ Î¶∞Ïπò', metric: 'PEG ÎπÑÏú®, Ï£ºÏãù Î∂ÑÎ•ò' },
                { title: 'ÏãúÏû•ÏùÑ Ïù¥Í∏∞Îäî ÏûëÏùÄ Ï±Ö', author: 'Ï°∞Ïóò Í∑∏Î¶∞Î∏îÎùºÌä∏', metric: 'ÎßàÎ≤ï Í≥µÏãù (ROC + EY)' },
                { title: 'Ï£ºÏãùÏãúÏû•ÏóêÏÑú ÎèàÎ≤ÑÎäî Î≤ï', author: 'ÏúåÎ¶¨ÏóÑ Ïò§Îãê', metric: 'CAN SLIM Ï†êÏàò' },
                { title: 'Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏÑ†ÌÉù', author: 'Ìï¥Î¶¨ ÎßàÏΩîÏúÑÏ∏†', metric: 'ÏÉ§ÌîÑ ÎπÑÏú®, Î∂ÑÏÇ∞Ìôî' },
                { title: 'ÌñâÏö¥Ïùò Í≥µÏãù', author: 'ÏúåÎ¶¨ÏóÑ ÌååÏö¥ÎìúÏä§ÌÜ§', metric: 'ÏºàÎ¶¨ Í∏∞Ï§Ä %' },
                { title: 'ÏõêÏπô (Ïò¨Ïõ®Îçî)', author: 'Î†àÏù¥ Îã¨Î¶¨Ïò§', metric: 'Î¶¨Ïä§ÌÅ¨ Ìå®Î¶¨Ìã∞, Í≤ΩÏ†ú ÏãúÏ¶å' },
                { title: 'Ìà¨ÏûêÏóê ÎåÄÌïú ÏÉùÍ∞Å', author: 'ÌïòÏõåÎìú ÎßâÏä§', metric: 'ÏúÑÌóò Ï†êÏàò, ÏãúÏû• ÏÇ¨Ïù¥ÌÅ¥' },
                { title: 'ÏúÑÎåÄÌïú Í∏∞ÏóÖÏóê Ìà¨ÏûêÌïòÎùº', author: 'ÌïÑÎ¶Ω ÌîºÏÖî', metric: 'Ï†ïÏÑ±Ï†Å Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏' },
                { title: 'Í∞ÄÎÇúÌïú Ï∞∞Î¶¨Ïùò Ïó∞Í∞ê', author: 'Ï∞∞Î¶¨ Î©çÍ±∞', metric: 'Î©òÌÉà Î™®Îç∏, Ïó≠Î∞úÏÉÅ' },
                { title: 'ÎûúÎç§ÏõåÌÅ¨ Ìà¨ÏûêÏàòÏóÖ', author: 'Î≤ÑÌäº ÎßêÌÇ§Ïóò', metric: 'Ìö®Ïú®Ï†Å ÏãúÏû•, Î∂ÑÏÇ∞' },
                { title: 'Î≥¥Í∏ÄÏùò Ìà¨Ïûê ÏõêÏπô', author: 'Ï°¥ Î≥¥Í∏Ä', metric: 'Ïù∏Îç±Ïä§ Ìà¨Ïûê, ÎπÑÏö© Ìö®Ïú®' },
                { title: 'Î∏îÎûô Ïä§ÏôÑ', author: 'ÎÇòÏã¨ ÌÉàÎ†ô', metric: 'ÌÖåÏùº Î¶¨Ïä§ÌÅ¨, ÏïàÌã∞ÌîÑÎûòÏßà' },
                { title: 'ÏïàÏ†ÑÎßàÏßÑ', author: 'ÏÑ∏Ïä§ ÌÅ¥ÎùºÎßå', metric: 'Í∑πÎã®Ï†Å Í∞ÄÏπòÌà¨Ïûê' },
                { title: 'ÏÉàÎ°úÏö¥ ÏãúÏû•Ïùò ÎßàÎ≤ïÏÇ¨Îì§', author: 'Ïû≠ ÏäàÏõ®Í±∞', metric: 'ÎìúÎü¨ÏºÑÎ∞ÄÎü¨ ÌÉëÎã§Ïö¥' }
            ];

            return books.map(b => `
                <div class="analysis-panel" style="padding: 12px; margin-bottom: 0;">
                    <div style="font-weight: bold; font-size: 0.85rem; color: #4ade80;">${b.title}</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">${b.author}</div>
                    <div style="font-size: 0.75rem; margin-top: 5px;">${b.metric}</div>
                </div>
            `).join('');
        }

        // ============================================
        // üì± Ï¢ÖÎ™© ÏÉÅÏÑ∏ Î™®Îã¨
        // ============================================

        function openStockModal(idx) {
            if (!globalData) return;
            const h = globalData.holdings[idx];
            const modal = document.getElementById('stockModal');

            document.getElementById('modalSymbol').textContent = h.symbol;
            document.getElementById('modalName').textContent = h.name;

            const mosGrade = h.marginOfSafety >= 20 ? 'A' : h.marginOfSafety >= 0 ? 'B' : h.marginOfSafety >= -20 ? 'C' : 'D';
            const pegGrade = h.pegRatio <= 0.5 ? 'A' : h.pegRatio <= 1 ? 'B' : h.pegRatio <= 2 ? 'C' : 'D';
            const riskGrade = h.riskScore <= 30 ? 'A' : h.riskScore <= 50 ? 'B' : h.riskScore <= 70 ? 'C' : 'D';

            document.getElementById('modalBody').innerHTML = `
                <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                <div class="modal-section">
                    <div class="modal-section-title">üìå Í∏∞Î≥∏ Ï†ïÎ≥¥</div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ÌòÑÏû¨Í∞Ä</div>
                            <div class="metric-value">${formatCurrency(h.current_price)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÎπÑÏ§ë</div>
                            <div class="metric-value">${h.weight.toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ÏÜêÏùµ</div>
                            <div class="metric-value ${h.gain_loss >= 0 ? 'positive' : 'negative'}">${formatCurrency(h.gain_loss)} (${formatPercent(h.gain_loss_pct)})</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Î¶∞Ïπò Î∂ÑÎ•ò</div>
                            <div class="metric-value"><span class="lynch-category ${h.lynchCategory.class}">${h.lynchCategory.category}</span></div>
                            <div class="metric-desc">${h.lynchCategory.desc}</div>
                        </div>
                    </div>
                </div>

                <!-- Î≤§ÏûêÎØº Í∑∏Î†àÏù¥ÏóÑ Î∂ÑÏÑù -->
                <div class="modal-section">
                    <div class="modal-section-title">üìñ Î≤§ÏûêÎØº Í∑∏Î†àÏù¥ÏóÑ Î∂ÑÏÑù <span class="book-ref">ÌòÑÎ™ÖÌïú Ìà¨ÏûêÏûê</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">Í∑∏Î†àÏù¥ÏóÑ ÎÑòÎ≤Ñ</div>
                            <div class="metric-value">${h.grahamNumber ? formatCurrency(h.grahamNumber) : 'N/A'}</div>
                            <div class="formula-box">‚àö(22.5 √ó EPS √ó Ï£ºÎãπÏàúÏûêÏÇ∞)</div>
                            <div class="metric-desc">Í∑∏Î†àÏù¥ÏóÑ ÎÑòÎ≤ÑÎäî Ï£ºÏãùÏùò ÏµúÎåÄ Ï†ÅÏ†ï Í∞ÄÍ≤©ÏùÑ ÎÇòÌÉÄÎÉÖÎãàÎã§. ÌòÑÏû¨Í∞ÄÍ∞Ä Ïù¥Î≥¥Îã§ ÎÇÆÏúºÎ©¥ Ï†ÄÌèâÍ∞ÄÏûÖÎãàÎã§.</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ÏïàÏ†ÑÎßàÏßÑ</div>
                            <div class="metric-value ${h.marginOfSafety >= 0 ? 'positive' : 'negative'}">${h.marginOfSafety?.toFixed(1)}%</div>
                            <div class="metric-desc">
                                <span class="analysis-grade grade-${mosGrade.toLowerCase()}">${mosGrade}Îì±Í∏â</span>
                                ${h.marginOfSafety >= 0 ? '‚úÖ ÎÇ¥Ïû¨Í∞ÄÏπò ÎåÄÎπÑ Ï†ÄÌèâÍ∞Ä' : '‚ö†Ô∏è ÎÇ¥Ïû¨Í∞ÄÏπò ÎåÄÎπÑ Í≥†ÌèâÍ∞Ä'}
                            </div>
                            <div class="formula-box">(ÎÇ¥Ïû¨Í∞ÄÏπò - ÌòÑÏû¨Í∞Ä) / ÎÇ¥Ïû¨Í∞ÄÏπò √ó 100</div>
                        </div>
                    </div>
                </div>

                <!-- ÌîºÌÑ∞ Î¶∞Ïπò Î∂ÑÏÑù -->
                <div class="modal-section">
                    <div class="modal-section-title">üìñ ÌîºÌÑ∞ Î¶∞Ïπò Î∂ÑÏÑù <span class="book-ref">ÏõîÍ∞ÄÏùò ÏòÅÏõÖ</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">PEG ÎπÑÏú®</div>
                            <div class="metric-value ${h.pegRatio <= 1 ? 'positive' : h.pegRatio <= 2 ? 'neutral' : 'negative'}">${h.pegRatio?.toFixed(2)}</div>
                            <div class="formula-box">P/E ÎπÑÏú® / Ïù¥ÏùµÏÑ±Ïû•Î•†</div>
                            <div class="metric-desc">
                                <span class="analysis-grade grade-${pegGrade.toLowerCase()}">${pegGrade}Îì±Í∏â</span>
                                ${h.pegRatio <= 1 ? '‚úÖ ÏÑ±Ïû• ÎåÄÎπÑ Ï†ÄÌèâÍ∞Ä (Î¶∞Ïπò Ï∂îÏ≤ú)' : h.pegRatio <= 2 ? '‚ö° Ï†ÅÏ†ï ÏàòÏ§Ä' : '‚ö†Ô∏è ÏÑ±Ïû• ÎåÄÎπÑ Í≥†ÌèâÍ∞Ä'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">P/E ÎπÑÏú®</div>
                            <div class="metric-value">${h.peRatio?.toFixed(1)}</div>
                            <div class="metric-desc">Ïù¥Ïùµ ÎåÄÎπÑ Ï£ºÍ∞Ä ÏàòÏ§Ä. ÎèôÏ¢Ö ÏóÖÍ≥Ñ ÌèâÍ∑†Í≥º ÎπÑÍµêÌïòÏÑ∏Ïöî.</div>
                        </div>
                    </div>
                </div>

                <!-- ÌïòÏõåÎìú ÎßâÏä§ Î∂ÑÏÑù -->
                <div class="modal-section">
                    <div class="modal-section-title">üìñ ÌïòÏõåÎìú ÎßâÏä§ ÏúÑÌóò Î∂ÑÏÑù <span class="book-ref">Ìà¨ÏûêÏóê ÎåÄÌïú ÏÉùÍ∞Å</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ÏúÑÌóò Ï†êÏàò</div>
                            <div class="metric-value">${h.riskScore?.toFixed(0)} / 100</div>
                            <div class="risk-meter">
                                ${[1,2,3,4,5].map(i => `
                                    <div class="risk-bar ${i <= Math.ceil(h.riskScore / 20) ? 'active' : ''}"></div>
                                `).join('')}
                            </div>
                            <div class="metric-desc">
                                <span class="analysis-grade grade-${riskGrade.toLowerCase()}">${riskGrade}Îì±Í∏â</span>
                                Î∞∏Î•òÏóêÏù¥ÏÖò, Î≥ÄÎèôÏÑ±, ÏßëÏ§ëÎèÑÎ•º Ï¢ÖÌï©Ìïú ÏúÑÌóò ÏßÄÌëú
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Î≥ÄÎèôÏÑ±</div>
                            <div class="metric-value">${h.volatility?.toFixed(1)}%</div>
                            <div class="metric-desc">Í∞ÄÍ≤© Î≥ÄÎèôÌè≠. ÎÜíÏùÑÏàòÎ°ù ÏúÑÌóòÌïòÏßÄÎßå Í∏∞ÌöåÎèÑ ÌÅº.</div>
                        </div>
                    </div>
                </div>

                <!-- ÎÇòÏã¨ ÌÉàÎ†ô Î∂ÑÏÑù -->
                <div class="modal-section">
                    <div class="modal-section-title">üìñ ÎÇòÏã¨ ÌÉàÎ†ô Î∂ÑÏÑù <span class="book-ref">Î∏îÎûô Ïä§ÏôÑ / ÏïàÌã∞ÌîÑÎûòÏßà</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">ÌîÑÎûòÏßàÎ¶¨Ìã∞ Ï†êÏàò</div>
                            <div class="metric-value" style="color: ${h.talebScore.color}">${h.talebScore.label}</div>
                            <div class="taleb-indicator">
                                <div class="taleb-block ${h.talebScore.category === 'fragile' ? 'fragile' : ''}"></div>
                                <div class="taleb-block ${h.talebScore.category === 'robust' ? 'robust' : ''}"></div>
                                <div class="taleb-block ${h.talebScore.category === 'antifragile' ? 'antifragile' : ''}"></div>
                            </div>
                            <div class="metric-desc">
                                ${h.talebScore.category === 'fragile' ? '‚ö†Ô∏è Í∑πÎã®Ï†Å Ï∂©Í≤©Ïóê Ï∑®ÏïΩ. Î†àÎ≤ÑÎ¶¨ÏßÄÏôÄ ÏßëÏ§ëÎèÑÎ•º Ï§ÑÏù¥ÏÑ∏Ïöî.' :
                                  h.talebScore.category === 'robust' ? '‚ö° Ï∂©Í≤©Ïóê Í≤¨Îîú Ïàò ÏûàÏùå. ÌòÑÏÉÅ Ïú†ÏßÄ Í∞ÄÎä•.' :
                                  '‚úÖ Î≥ÄÎèôÏÑ±ÏóêÏÑú Ïù¥ÏùµÏùÑ ÏñªÏùÑ Ïàò ÏûàÎäî Íµ¨Ï°∞'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Î∂ÄÏ±ÑÎπÑÏú®</div>
                            <div class="metric-value">${(h.debtToEquity * 100).toFixed(0)}%</div>
                            <div class="metric-desc">ÎÜíÏùÄ Î†àÎ≤ÑÎ¶¨ÏßÄÎäî ÌîÑÎûòÏßàÎ¶¨Ìã∞Î•º ÎÜíÏûÖÎãàÎã§.</div>
                        </div>
                    </div>
                </div>

                <!-- Ï∞∞Î¶¨ Î©çÍ±∞ Î∂ÑÏÑù -->
                <div class="modal-section">
                    <div class="modal-section-title">üìñ Ï∞∞Î¶¨ Î©çÍ±∞ Î∂ÑÏÑù <span class="book-ref">Í∞ÄÎÇúÌïú Ï∞∞Î¶¨Ïùò Ïó∞Í∞ê</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">Î©çÍ±∞ Ï†êÏàò</div>
                            <div class="metric-value">${h.mungerScore?.toFixed(0)} / 100</div>
                            <div class="metric-desc">Í≤ΩÏüÅÏö∞ÏúÑ(Moat), ROIC, Í≤ΩÏòÅÏßÑ ÌíàÏßàÏùÑ Ï¢ÖÌï© ÌèâÍ∞Ä</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Ìà¨ÌïòÏûêÎ≥∏ÏàòÏùµÎ•† (ROIC)</div>
                            <div class="metric-value ${h.roic > 15 ? 'positive' : h.roic > 10 ? 'neutral' : 'negative'}">${h.roic?.toFixed(1)}%</div>
                            <div class="metric-desc">${h.roic > 15 ? '‚úÖ Îõ∞Ïñ¥ÎÇú ÏûêÎ≥∏ Ìö®Ïú®ÏÑ±' : h.roic > 10 ? '‚ö° ÏñëÌò∏Ìïú ÏàòÏ§Ä' : '‚ö†Ô∏è ÏûêÎ≥∏ Ìö®Ïú®ÏÑ± Í∞úÏÑ† ÌïÑÏöî'}</div>
                        </div>
                    </div>
                </div>

                <!-- ÎßàÎ≤ï Í≥µÏãù Î∂ÑÏÑù -->
                <div class="modal-section">
                    <div class="modal-section-title">üìñ Í∑∏Î¶∞Î∏îÎùºÌä∏ ÎßàÎ≤ï Í≥µÏãù <span class="book-ref">ÏãúÏû•ÏùÑ Ïù¥Í∏∞Îäî ÏûëÏùÄ Ï±Ö</span></div>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">Ïù¥ÏùµÏàòÏùµÎ•† (Earnings Yield)</div>
                            <div class="metric-value">${h.earningsYield?.toFixed(1)}%</div>
                            <div class="formula-box">EBIT / Í∏∞ÏóÖÍ∞ÄÏπò</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ÏûêÎ≥∏ÏàòÏùµÎ•† (ROC)</div>
                            <div class="metric-value">${h.roc?.toFixed(1)}%</div>
                            <div class="formula-box">EBIT / (ÏàúÏö¥Ï†ÑÏûêÎ≥∏ + Í≥†Ï†ïÏûêÏÇ∞)</div>
                        </div>
                    </div>
                </div>

                <!-- Ìà¨Ïûê Í∂åÏû•ÏÇ¨Ìï≠ -->
                <div class="recommendation-box">
                    <div class="recommendation-title">üí° Ï¢ÖÌï© Ìà¨Ïûê Í∂åÏû•ÏÇ¨Ìï≠</div>
                    <ul class="recommendation-list">
                        ${generateRecommendations(h)}
                    </ul>
                </div>
            `;

            modal.classList.add('active');
        }

        function generateRecommendations(h) {
            const recs = [];

            if (h.marginOfSafety < -30) {
                recs.push(`Í∑∏Î†àÏù¥ÏóÑ Í¥ÄÏ†ê: ÌòÑÏû¨Í∞ÄÍ∞Ä ÎÇ¥Ïû¨Í∞ÄÏπòÎ≥¥Îã§ ${Math.abs(h.marginOfSafety).toFixed(0)}% ÎÜíÏäµÎãàÎã§. Îß§ÏàòÎ≥¥Îã§ Í¥ÄÎßù Í∂åÏû•.`);
            } else if (h.marginOfSafety > 20) {
                recs.push(`Í∑∏Î†àÏù¥ÏóÑ Í¥ÄÏ†ê: ${h.marginOfSafety.toFixed(0)}% ÏïàÏ†ÑÎßàÏßÑÏúºÎ°ú Îß§Î†•Ï†ÅÏù∏ Í∞ÄÏπòÏ£ºÏûÖÎãàÎã§.`);
            }

            if (h.pegRatio <= 1) {
                recs.push(`Î¶∞Ïπò Í¥ÄÏ†ê: PEG ${h.pegRatio.toFixed(2)}Î°ú ÏÑ±Ïû• ÎåÄÎπÑ Ï†ÄÌèâÍ∞Ä. Ï∂îÍ∞Ä Îß§Ïàò Í≥†Î†§.`);
            } else if (h.pegRatio > 2.5) {
                recs.push(`Î¶∞Ïπò Í¥ÄÏ†ê: PEG ${h.pegRatio.toFixed(2)}Î°ú ÏÑ±Ïû• ÎåÄÎπÑ Í≥†ÌèâÍ∞Ä. ÎπÑÏ§ë Ï∂ïÏÜå Í≤ÄÌÜ†.`);
            }

            if (h.weight > 25) {
                recs.push(`ÎßâÏä§ Í¥ÄÏ†ê: ${h.weight.toFixed(1)}% ÏßëÏ§ëÎèÑÎäî ÎπÑÎåÄÏπ≠ Î¶¨Ïä§ÌÅ¨Î•º Ï¥àÎûò. Î∂ÑÏÇ∞ ÌïÑÏöî.`);
            }

            if (h.talebScore.category === 'fragile') {
                recs.push(`ÌÉàÎ†ô Í¥ÄÏ†ê: Î∏îÎûôÏä§ÏôÑ Ïù¥Î≤§Ìä∏Ïóê Ï∑®ÏïΩ. Ìó§ÏßÄ Ï†ÑÎûµ ÎòêÎäî Ìè¨ÏßÄÏÖò Ï∂ïÏÜå Í∂åÏû•.`);
            }

            if (h.roic > 20) {
                recs.push(`Î©çÍ±∞ Í¥ÄÏ†ê: Îõ∞Ïñ¥ÎÇú ROIC(${h.roic.toFixed(1)}%)Îäî Í≤ΩÏüÅÏö∞ÏúÑÏùò Ï¶ùÍ±∞. Ïû•Í∏∞ Î≥¥Ïú† Ï†ÅÌï©.`);
            }

            if (recs.length === 0) {
                recs.push('Ï¢ÖÌï©Ï†ÅÏúºÎ°ú ÌòÑÏû¨ Ìè¨ÏßÄÏÖò Ïú†ÏßÄÍ∞Ä Ï†ÅÏ†àÌï¥ Î≥¥ÏûÖÎãàÎã§. Ï†ïÍ∏∞Ï†ÅÏúºÎ°ú Ïû¨ÌèâÍ∞ÄÌïòÏÑ∏Ïöî.');
            }

            return recs.map(r => `<li>${r}</li>`).join('');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        function closeModalOnOverlay(event) {
            if (event.target === document.getElementById('stockModal')) {
                closeStockModal();
            }
        }

        // ============================================
        // üß† Ïù∏ÏÇ¨Ïù¥Ìä∏ & ÏãúÏû• Ï†ÑÎßù Î™®Îã¨
        // ============================================

        function openInsightModal() {
            if (!globalData) return;
            const modal = document.getElementById('insightModal');
            const bookMetrics = globalData.bookMetrics;
            const insights = generateInsights(globalData, bookMetrics);
            const marketData = generateMarketOutlook();
            const marketOpinions = generateMarketOpinion(marketData, bookMetrics);

            document.getElementById('insightModalBody').innerHTML = `
                <!-- ÏãúÏû• Ï†ÑÎßù ÏÑπÏÖò -->
                <div class="modal-section">
                    <div class="modal-section-title">üìà ÏãúÏû• Ï†ÑÎßù ÏßÄÌëú</div>
                    <div class="market-outlook-grid">
                        <div class="market-card">
                            <div class="market-label">VIX (Í≥µÌè¨ÏßÄÏàò)</div>
                            <div class="market-value">${marketData.vix.value}</div>
                            <div class="market-status ${marketData.vix.class}">${marketData.vix.status}</div>
                        </div>
                        <div class="market-card">
                            <div class="market-label">S&P 500 CAPE</div>
                            <div class="market-value">${marketData.cape.value}</div>
                            <div class="market-status ${marketData.cape.class}">${marketData.cape.status}</div>
                        </div>
                        <div class="market-card">
                            <div class="market-label">Í≥µÌè¨ÌÉêÏöï ÏßÄÏàò</div>
                            <div class="market-value">${marketData.fearGreed.value}</div>
                            <div class="market-status ${marketData.fearGreed.class}">${marketData.fearGreed.status}</div>
                        </div>
                        <div class="market-card">
                            <div class="market-label">ÏàòÏùµÎ•† Í≥°ÏÑ†</div>
                            <div class="market-value">${marketData.yieldCurve.value}</div>
                            <div class="market-status ${marketData.yieldCurve.class}">${marketData.yieldCurve.status}</div>
                        </div>
                    </div>

                    <!-- Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ -->
                    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-top: 10px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">üîÑ Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥ ÏúÑÏπò: <span style="color: #4ade80;">${marketData.cycle.label}</span></div>
                        <div class="cycle-indicator">
                            <div style="text-align: center; flex: 1;">
                                <div class="cycle-phase ${marketData.cycle.phase === 'expansion' ? 'expansion' : ''}" style="height: 20px;"></div>
                                <div class="cycle-label">ÌôïÏû•Í∏∞</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div class="cycle-phase ${marketData.cycle.phase === 'peak' ? 'peak' : ''}" style="height: 20px;"></div>
                                <div class="cycle-label">Ï†ïÏ†ê</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div class="cycle-phase ${marketData.cycle.phase === 'contraction' ? 'contraction' : ''}" style="height: 20px;"></div>
                                <div class="cycle-label">ÏàòÏ∂ïÍ∏∞</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div class="cycle-phase ${marketData.cycle.phase === 'trough' ? 'trough' : ''}" style="height: 20px;"></div>
                                <div class="cycle-label">Ï†ÄÏ†ê</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; color: rgba(255,255,255,0.7); font-size: 0.9rem;">${marketData.cycle.desc}</div>
                    </div>
                </div>

                <!-- ÏãúÏû• ÏùòÍ≤¨ ÏÑπÏÖò -->
                <div class="modal-section">
                    <div class="modal-section-title">üí¨ ÏãúÏû• ÏùòÍ≤¨ Î∞è Í∂åÍ≥†ÏÇ¨Ìï≠</div>
                    <div class="market-opinion-box">
                        <div class="market-opinion-title">üéØ Ï¢ÖÌï© ÏãúÏû• Î∂ÑÏÑù</div>
                        <div class="market-opinion-content">
                            ${marketOpinions.map(opinion => `<p style="margin-bottom: 12px;">‚Ä¢ ${opinion}</p>`).join('')}
                        </div>
                    </div>
                </div>

                <!-- Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏÑπÏÖò -->
                <div class="modal-section">
                    <div class="modal-section-title">üß† Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ïù∏ÏÇ¨Ïù¥Ìä∏ <span class="book-ref">16Í∂åÏùò Ìà¨Ïûê Î™ÖÏ†Ä Í∏∞Î∞ò</span></div>
                    <div class="two-col-grid">
                        ${renderInsightsHTML(insights)}
                    </div>
                </div>

                <!-- ÏÑπÌÑ∞ Î°úÌÖåÏù¥ÏÖò Ï∂îÏ≤ú -->
                <div class="modal-section">
                    <div class="modal-section-title">üîÑ Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥Î≥Ñ ÏÑπÌÑ∞ Ï∂îÏ≤ú</div>
                    <div class="metric-grid">
                        <div class="metric-card ${marketData.cycle.phase === 'expansion' ? 'highlight' : ''}" style="${marketData.cycle.phase === 'expansion' ? 'border: 2px solid #4ade80;' : ''}">
                            <div class="metric-label">ÌôïÏû•Í∏∞ Ï∂îÏ≤ú ÏÑπÌÑ∞</div>
                            <div class="metric-value" style="font-size: 1rem;">Í∏∞Ïà†, ÏÜåÎπÑÏû¨, ÏÇ∞ÏóÖÏû¨</div>
                            <div class="metric-desc">Í≤ΩÏ†ú ÏÑ±Ïû•Í≥º Ìï®Íªò ÏàòÌòú Î∞õÎäî ÏÑ±Ïû•Ï£º Ï§ëÏã¨</div>
                        </div>
                        <div class="metric-card ${marketData.cycle.phase === 'peak' ? 'highlight' : ''}" style="${marketData.cycle.phase === 'peak' ? 'border: 2px solid #fbbf24;' : ''}">
                            <div class="metric-label">Ï†ïÏ†ê Ï∂îÏ≤ú ÏÑπÌÑ∞</div>
                            <div class="metric-value" style="font-size: 1rem;">ÏóêÎÑàÏßÄ, ÏÜåÏû¨, Í∏àÏúµ</div>
                            <div class="metric-desc">Ïù∏ÌîåÎ†àÏù¥ÏÖò Ìó§ÏßÄ Î∞è Ïù¥Ïùµ Ïã§ÌòÑ</div>
                        </div>
                        <div class="metric-card ${marketData.cycle.phase === 'contraction' ? 'highlight' : ''}" style="${marketData.cycle.phase === 'contraction' ? 'border: 2px solid #f87171;' : ''}">
                            <div class="metric-label">ÏàòÏ∂ïÍ∏∞ Ï∂îÏ≤ú ÏÑπÌÑ∞</div>
                            <div class="metric-value" style="font-size: 1rem;">Ìó¨Ïä§ÏºÄÏñ¥, Ïú†Ìã∏Î¶¨Ìã∞, ÌïÑÏàòÏÜåÎπÑÏû¨</div>
                            <div class="metric-desc">Î∞©Ïñ¥Ï†Å ÏÑπÌÑ∞Î°ú ÌïòÎùΩÏû• Î∞©Ïñ¥</div>
                        </div>
                        <div class="metric-card ${marketData.cycle.phase === 'trough' ? 'highlight' : ''}" style="${marketData.cycle.phase === 'trough' ? 'border: 2px solid #60a5fa;' : ''}">
                            <div class="metric-label">Ï†ÄÏ†ê Ï∂îÏ≤ú ÏÑπÌÑ∞</div>
                            <div class="metric-value" style="font-size: 1rem;">Í∏àÏúµ, Î∂ÄÎèôÏÇ∞, ÏÜåÎπÑÏû¨</div>
                            <div class="metric-desc">ÌöåÎ≥µ ÏàòÌòú ÏÑπÌÑ∞ ÏÑ†Ï∑®Îß§</div>
                        </div>
                    </div>
                </div>

                <!-- Ìà¨Ïûê Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ -->
                <div class="recommendation-box">
                    <div class="recommendation-title">üìã ÌòÑÏû¨ ÏãúÏû• ÏÉÅÌô© Ìà¨Ïûê Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</div>
                    <ul class="recommendation-list">
                        <li>Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Î¶¨Î∞∏Îü∞Ïã± ÌïÑÏöî Ïó¨Î∂Ä Ï†êÍ≤Ä</li>
                        <li>ÌòÑÍ∏à ÎπÑÏ§ë Ï†ÅÏ†ïÏÑ± ÌôïÏù∏ (Í∂åÏû•: ${marketData.vix.class === 'bearish' ? '20-30%' : marketData.cycle.phase === 'peak' ? '15-20%' : '5-15%'})</li>
                        <li>Í≤ΩÍ∏∞ ÏÇ¨Ïù¥ÌÅ¥(${marketData.cycle.label})Ïóê ÎßûÎäî ÏÑπÌÑ∞ ÎπÑÏ§ë Ï†êÍ≤Ä</li>
                        <li>Í∞úÎ≥Ñ Ï¢ÖÎ™© ÏÜêÏ†à/ÏùµÏ†à ÎùºÏù∏ Ïû¨ÌôïÏù∏</li>
                        <li>Î∂ÑÏÇ∞ Ìà¨Ïûê Ï†ÅÏ†ïÏÑ± Ï†êÍ≤Ä (Ï¢ÖÎ™© Ïàò, ÏÑπÌÑ∞ Î∂ÑÏÇ∞)</li>
                    </ul>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeInsightModal() {
            document.getElementById('insightModal').classList.remove('active');
        }

        function closeInsightModalOnOverlay(event) {
            if (event.target === document.getElementById('insightModal')) {
                closeInsightModal();
            }
        }

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeStockModal();
                closeInsightModal();
            }
        });

        // ============================================
        // üìä Ï∞®Ìä∏ Î†åÎçîÎßÅ
        // ============================================

        function renderAllocationChart(holdings) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            const colors = ['#4ade80', '#60a5fa', '#f472b6', '#facc15', '#a78bfa', '#fb923c', '#2dd4bf', '#f87171', '#818cf8', '#34d399', '#fbbf24', '#f43f5e'];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: holdings.map(h => h.symbol),
                    datasets: [{
                        data: holdings.map(h => h.market_value),
                        backgroundColor: colors.slice(0, holdings.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#fff', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderEconomicSeasonsChart(seasons) {
            const ctx = document.getElementById('economicSeasonsChart').getContext('2d');

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ÏÑ±Ïû• ÏÉÅÏäπ', 'Ïù∏ÌîåÎ†àÏù¥ÏÖò ÏÉÅÏäπ', 'ÏÑ±Ïû• ÌïòÎùΩ', 'Ïù∏ÌîåÎ†àÏù¥ÏÖò ÌïòÎùΩ'],
                    datasets: [{
                        label: 'Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÎÖ∏Ï∂úÎèÑ',
                        data: [seasons.growth, seasons.inflation, seasons.recession, seasons.deflation],
                        backgroundColor: 'rgba(74, 222, 128, 0.2)',
                        borderColor: '#4ade80',
                        borderWidth: 2,
                        pointBackgroundColor: '#4ade80'
                    }, {
                        label: 'Ïù¥ÏÉÅÏ†Å (Í∞Å 25%)',
                        data: [25, 25, 25, 25],
                        backgroundColor: 'rgba(255, 255, 255, 0.05)',
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointBackgroundColor: 'rgba(255, 255, 255, 0.3)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 9 } },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#fff', font: { size: 10 } }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderRiskContributionChart(riskContributions) {
            const ctx = document.getElementById('riskContributionChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: riskContributions.map(r => r.symbol),
                    datasets: [{
                        label: 'ÏúÑÌóò Í∏∞Ïó¨ÎèÑ %',
                        data: riskContributions.map(r => r.riskContribution),
                        backgroundColor: riskContributions.map(r =>
                            r.isOverweight ? '#ef4444' : '#4ade80'
                        ),
                        borderRadius: 4
                    }, {
                        label: 'ÎπÑÏ§ë %',
                        data: riskContributions.map(r => r.weight),
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.6)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 9 } },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#fff', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderPortfolioHistoryChart(portfolioHistory) {
            if (!portfolioHistory || portfolioHistory.length < 2) {
                return;
            }

            document.getElementById('historyChartContainer').style.display = 'block';
            const ctx = document.getElementById('historyChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: portfolioHistory.map(d => d.date),
                    datasets: [{
                        label: 'Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Í∞ÄÏπò',
                        data: portfolioHistory.map(d => d.total_value),
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        fill: true,
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#4ade80'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => formatCurrency(ctx.raw)
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'rgba(255,255,255,0.6)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255,255,255,0.6)',
                                callback: value => '$' + value.toLocaleString()
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
        }
    </script>
</body>
</html>
